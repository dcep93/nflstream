!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.P2PEngine=t():e.P2PEngine=t()}(self,(()=>(()=>{var __webpack_modules__={949:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();t.createTimeoutGenerator=function(){return new s((function(e){var t=void 0;return{execute:function(){t=setTimeout(e,arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3)},cancel:function(){clearTimeout(t)}}}))};var r=1,i=2,o=3,a=4;var s=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.generator=t,this.status=r,this.next=this.next.bind(this)}return n(e,[{key:"next",value:function(e){if(this.status===a)return console.warn("status is canceled");if(this.status===i)return console.warn("status is waiting");var t=this.execute.bind(this,this.cb);this.nextInfo=this.generator(t),this.status=i,this.nextInfo.execute(e)}},{key:"execute",value:function(e,t){this.status=o,e.apply(t,[this.next])}},{key:"cancel",value:function(){this.status=a,this.nextInfo&&"function"==typeof this.nextInfo.cancel&&this.nextInfo.cancel()}},{key:"start",value:function(e,t){if("function"!=typeof e)throw new SyntaxError("param cb must be a function");this.cb=e,this.next(t)}},{key:"continue",value:function(e){this.status=r,this.next(e)}}]),e}()},673:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=s(n(934)),a=s(n(356));function s(e){return e&&e.__esModule?e:{default:e}}var u=function(e){function t(e,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return r.requestingMap=new a.default,r.bitset=new Set,r.bitCounts=new Map,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),i(t,[{key:"handshakePeer",value:function(e){this._setupDC(e),e.sendMetaData(Array.from(this.bitset),this.sequential,this.peersNum)}},{key:"handleMetaData",value:function(e,t){var n=this;t.field&&(e.bitset=new Set(t.field),t.field.forEach((function(e){n.bitset.has(e)||n._increBitCounts(e)})),this.addPeer(e),this.downloadOnly&&this.chokePeerRequest(e))}},{key:"peersHas",value:function(e){return this.bitCounts.has(e)}},{key:"_decreBitCounts",value:function(e){if(this.bitCounts.has(e)){var t=this.bitCounts.get(e);1===t?this.bitCounts.delete(e):this.bitCounts.set(e,t-1)}}},{key:"_increBitCounts",value:function(e){if(this.bitCounts.has(e)){var t=this.bitCounts.get(e);this.bitCounts.set(e,t+1)}else this.bitCounts.set(e,1)}},{key:"reportDCTraffic",value:function(e,t,n){if(this.engine.fetcher){var r=this.engine.fetcher,i=t;this.bitset.has(e)||r.reportDCTraffic(i,n)}else this.logger.error("DC report failed")}},{key:"cleanRequestingMap",value:function(e){var t=this.peerManager.getPeer(e),n=!0,i=!1,o=void 0;try{for(var a,s=this.requestingMap.internalMap[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var u=r(a.value,2),l=u[0],c=u[1];c&&c.includes(e)&&(this.logger.info("delete "+l+" in requestingMap"),this.requestingMap.delete(l),this._decreBitCounts(l),t&&t.bitset.delete(l))}}catch(e){i=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw o}}}},{key:"getPeerLoadedMore",value:function(e){if(!this.requestingMap.has(e))return null;var t=this.requestingMap.getAllPeerIds(e);if(0===t.length)return null;var n=this.peerManager.getPeer(t[0]);if(!n)return null;if(t.length>1)for(var r=1;r<t.length;r++){var i=this.peerManager.getPeer(t[r]);i&&i.bufArr.length>n.bufArr.length&&(n=i)}return n}}]),t}(o.default);t.default=u,e.exports=t.default},304:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={wsMaxRetries:10,p2pEnabled:!0,wifiOnly:!1,memoryCacheLimit:{pc:629145600,mobile:314572800},dcDownloadTimeout:25,logLevel:"error",tag:"",webRTCConfig:{},token:void 0,appName:void 0,appId:void 0,prefetchNum:5,showSlogan:!1,trickleICE:!1,announceLocation:"cn",geoIpPreflight:!0,getStats:function(e,t,n){},getPeerId:function(e){},getPeersInfo:function(e){}};t.default=n,e.exports=t.default},979:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=d(n(204)),a=d(n(88)),s=d(n(622)),u=n(901),l=d(n(542)),c=d(n(206)),f=d(n(497));function d(e){return e&&e.__esModule?e:{default:e}}function h(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var g="nllL",v="d3NzJ",_="==",y="TNBLy9z",b="aWduY",m="mNvbQ",w="WwuY2RuY",P=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};h(this,t);var n=p(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(n.p2pEnabled=!(!1===e.p2pEnabled||"0"===(0,u.getQueryParam)("_p2p")),e.tag&&e.tag.length>20)throw new Error("Tag is too long");if(e.appName&&e.appName.length>30)throw new Error("appName is too long");if(e.appId&&e.appId.length>30)throw new Error("appId is too long");if(e.token&&e.token.length>20)throw new Error("Token is too long");return n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),i(t,[{key:"initLogger",value:function(){var e=this.config;e.showSlogan&&"en"===(0,u.navLang)()&&console.log("%cEmpower your users to become the unlimitedly scalable CDN!\n%c"+(0,u.getHomeUrl)(),"color: dodgerblue; padding:20px 0; font-size: x-large","font-size: medium; padding-bottom:15px");var t=new a.default(e.logLevel);return e.logger=this.logger=t,t}},{key:"makeChannelId",value:function(e,t){if(!e||"string"!=typeof e){var n="token is required while using customized channelId!";throw console.error(n),new Error(n)}return function(n,r){return e+"-"+t(n,r)}}},{key:"makeSignalId",value:function(){var e="",t=this.config,n=decodeURIComponent(window.atob(v+y+b+w+g+m+_));if(t.wsSignalerAddr){var i=void 0;"object"!==r(t.wsSignalerAddr)||t.wsSignalerAddr.backup?"string"==typeof t.wsSignalerAddr&&(i=t.wsSignalerAddr):i=t.wsSignalerAddr.main,i===n&&(i=void 0),i&&(e=s.default.parseURL(i).netLoc.substr(2))}else t.wsSignalerAddr=n;return e}},{key:"setupWindowListeners",value:function(e){var t=this,n=["iPad","iPhone"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",r=function e(){t.fetcher&&t.fetcher.postStatsWithBeacon(),t.p2pEnabled&&t.disableP2P(),window.removeEventListener(n,e)};e?window.removeEventListener(n,r):window.addEventListener(n,r)}},{key:"destroy",value:function(){this.disableP2P(!0),this.removeAllListeners(),this.setupWindowListeners(!0)}},{key:"enableP2P",value:function(){return this.p2pEnabled?null:(this.logger&&this.logger.info("enable P2P"),this.config.p2pEnabled=this.p2pEnabled=!0,this.browserInfo?(this._init(this.channel,this.browserInfo),this):null)}},{key:"commonBrowserInfo",get:function(){var e=c.default.getPlatform(),t=c.default.getNetType()||"wifi";return this.netType=t,{device:e,netType:t,player:(0,f.default)()||void 0}}},{key:"version",get:function(){return t.version}}],[{key:"isSupported",value:function(){var e=(0,u.getBrowserRTC)();return!(!e||void 0===e.RTCPeerConnection.prototype.createDataChannel)}}]),t}(o.default);P.version="1.20.10",P.protocolVersion=l.default.VERSION,t.default=P,e.exports=t.default},784:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={DC_SIGNAL:"SIGNAL",DC_OPEN:"OPEN",DC_REQUEST:"REQUEST",DC_PIECE_NOT_FOUND:"PIECE_NOT_FOUND",DC_PIECE_ABORT:"PIECE_ABORT",DC_PIECE_CANCEL:"PIECE_CANCEL",DC_CLOSE:"CLOSE",DC_RESPONSE:"RESPONSE",DC_ERROR:"ERROR",DC_PIECE:"PIECE",DC_PIECE_DATA:"PIECE_DATA",DC_TIMEOUT:"TIMEOUT",DC_PIECE_ACK:"PIECE_ACK",DC_METADATA:"METADATA",DC_PLAT_ANDROID:"ANDROID",DC_PLAT_IOS:"IOS",DC_PLAT_WEB:"WEB",DC_CHOKE:"CHOKE",DC_UNCHOKE:"UNCHOKE",DC_HAVE:"HAVE",DC_HAVE_REVERSE:"HAVE_REVERSE",DC_LOST:"LOST",DC_GET_PEERS:"GET_PEERS",DC_PEERS:"PEERS",DC_STATS:"STATS",DC_PEER_SIGNAL:"PEER_SIGNAL",DC_PLAYLIST:"PLAYLIST",BM_LOST:"lost",BM_ADDED_SEG_:"BM_ADDED_SEG_",BM_ADDED_SN_:"BM_ADDED_SN_",BM_SEG_ADDED:"BM_SEG_ADDED",FRAG_CHANGED:"FRAG_CHANGED",FRAG_LOADED:"FRAG_LOADED",FRAG_LOADING:"FRAG_LOADING",RESTART_P2P:"RESTART_P2P",EXCEPTION:"exception",REQUESTING_MAP_HAVE:"REQUESTING_MAP_HAVE",BUILDER_MAP_HAVE:"BUILDER_MAP_HAVE",SYN_OUTPUT:"SYN_OUTPUT",SYN_ERROR:"SYN_ERROR",SYN_PARTIAL:"SYN_PARTIAL"},e.exports=t.default},746:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(901),a=l(n(204)),s=l(n(3)),u=n(9);function l(e){return e&&e.__esModule?e:{default:e}}function c(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var f=65536;function d(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}var h=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=c(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));n.channelName=e.initiator?e.channelName:null,n.initiator=e.initiator||!1,n.channelConfig=e.channelConfig||t.channelConfig,n.channelNegotiated=n.channelConfig.negotiated,n.config=Object.assign({},t.config,e.config),n.offerOptions=e.offerOptions||{},n.answerOptions=e.answerOptions||{},n.sdpTransform=e.sdpTransform||function(e){return e},n.trickle=void 0===e.trickle||e.trickle,n.allowHalfTrickle=void 0!==e.allowHalfTrickle&&e.allowHalfTrickle,n.iceCompleteTimeout=e.iceCompleteTimeout||5e3,n.destroyed=!1,n.destroying=!1,n._connected=!1,n.remoteAddress=void 0,n.remoteFamily=void 0,n.remotePort=void 0,n.localAddress=void 0,n.localFamily=void 0,n.localPort=void 0,n._wrtc=e.wrtc&&"object"===r(e.wrtc)?e.wrtc:(0,o.getBrowserRTC)(),n._pcReady=!1,n._channelReady=!1,n._iceComplete=!1,n._iceCompleteTimer=null,n._channel=null,n._pendingCandidates=[],n._isNegotiating=!1,n._firstNegotiation=!0,n._batchedNegotiation=!1,n._queuedNegotiation=!1,n._sendersAwaitingStable=[],n._senderMap=new Map,n._closingInterval=null,n._chunk=null,n._cb=null,n._interval=null;try{n._pc=new n._wrtc.RTCPeerConnection(n.config)}catch(e){return(0,s.default)((function(){return n.destroy(e)})),c(n)}return n._isReactNativeWebrtc="number"==typeof n._pc._peerConnectionId,n._pc.oniceconnectionstatechange=function(){n._onIceStateChange()},n._pc.onicegatheringstatechange=function(){n._onIceStateChange()},n._pc.onconnectionstatechange=function(){n._onConnectionStateChange()},n._pc.onsignalingstatechange=function(){n._onSignalingStateChange()},n._pc.onicecandidate=function(e){n._onIceCandidate(e)},n.initiator||n.channelNegotiated?n._setupData({channel:n._pc.createDataChannel(n.channelName,n.channelConfig)}):n._pc.ondatachannel=function(e){n._setupData(e)},n._needsNegotiation(),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),i(t,[{key:"signal",value:function(e){var t=this;if(this.destroyed)throw new Error("cannot signal after peer is destroyed");if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}e.renegotiate&&this.initiator&&this._needsNegotiation(),e.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(e)).then((function(){t.destroyed||(t._pendingCandidates.forEach((function(e){t._addIceCandidate(e)})),t._pendingCandidates=[],"offer"===t._pc.remoteDescription.type&&t._createAnswer())})).catch((function(e){t.destroy(e)})),e.sdp||e.candidate||e.renegotiate||e.transceiverRequest||this.destroy(new Error("signal() called with invalid signal data"))}},{key:"_addIceCandidate",value:function(e){var t=this,n=new this._wrtc.RTCIceCandidate(e);this._pc.addIceCandidate(n).catch((function(e){var r;!n.address||n.address.endsWith(".local")?(r="Ignoring unsupported ICE candidate.",console.warn(r)):t.destroy(e)}))}},{key:"send",value:function(e){this._channel.send(e)}},{key:"_needsNegotiation",value:function(){var e=this;this._batchedNegotiation||(this._batchedNegotiation=!0,(0,s.default)((function(){e._batchedNegotiation=!1,!e.initiator&&e._firstNegotiation||e.negotiate(),e._firstNegotiation=!1})))}},{key:"negotiate",value:function(){var e=this;this.initiator?this._isNegotiating?this._queuedNegotiation=!0:setTimeout((function(){e._createOffer()}),0):this._isNegotiating?this._queuedNegotiation=!0:this.emit("signal",{type:"renegotiate",renegotiate:!0}),this._isNegotiating=!0}},{key:"destroy",value:function(e){this._destroy(e)}},{key:"_destroy",value:function(e){var t=this;this.destroyed||this.destroying||(this.destroying=!0,(0,s.default)((function(){if(t.destroyed=!0,t.destroying=!1,t._connected=!1,t._pcReady=!1,t._channelReady=!1,t._senderMap=null,clearInterval(t._closingInterval),t._closingInterval=null,clearInterval(t._interval),t._interval=null,t._chunk=null,t._cb=null,t._channel){try{t._channel.close()}catch(e){}t._channel.onmessage=null,t._channel.onopen=null,t._channel.onclose=null,t._channel.onerror=null}if(t._pc){try{t._pc.close()}catch(e){}t._pc.oniceconnectionstatechange=null,t._pc.onicegatheringstatechange=null,t._pc.onsignalingstatechange=null,t._pc.onicecandidate=null,t._pc.ondatachannel=null}t._pc=null,t._channel=null,e&&t.emit("error",e),t.emit("close")})))}},{key:"_setupData",value:function(e){var t=this;if(!e.channel)return this.destroy(new Error("Data channel event is missing `channel` property"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=f),this.channelName=this._channel.label,this._channel.onmessage=function(e){t._onChannelMessage(e)},this._channel.onbufferedamountlow=function(){t._onChannelBufferedAmountLow()},this._channel.onopen=function(){t._onChannelOpen()},this._channel.onclose=function(){t._onChannelClose()},this._channel.onerror=function(e){t.destroy(e)};var n=!1;this._closingInterval=setInterval((function(){t._channel&&"closing"===t._channel.readyState?(n&&t._onChannelClose(),n=!0):n=!1}),5e3)}},{key:"write",value:function(e,t){if(this.destroyed)return t(new Error("cannot write after peer is destroyed"));if(this._connected){try{this.send(e)}catch(e){return this.destroy(e)}this.isBufferedAmountHigh?this._cb=t:t(null)}else this._chunk=e,this._cb=t}},{key:"_startIceCompleteTimeout",value:function(){var e=this;this.destroyed||this._iceCompleteTimer||(this._iceCompleteTimer=setTimeout((function(){e._iceComplete||(e._iceComplete=!0,e.emit("iceTimeout"),e.emit("_iceComplete"))}),this.iceCompleteTimeout))}},{key:"_createOffer",value:function(){var e=this;this.destroyed||this._pc.createOffer(this.offerOptions).then((function(t){if(!e.destroyed){e.trickle||e.allowHalfTrickle||(t.sdp=d(t.sdp)),t.sdp=e.sdpTransform(t.sdp);var n=function(){if(!e.destroyed){var n=e._pc.localDescription||t;e.emit("signal",{type:n.type,sdp:n.sdp})}};e._pc.setLocalDescription(t).then((function(){e.destroyed||(e.trickle||e._iceComplete?n():e.once("_iceComplete",n))})).catch((function(t){e.destroy(t)}))}})).catch((function(t){e.destroy(t)}))}},{key:"_createAnswer",value:function(){var e=this;this.destroyed||this._pc.createAnswer(this.answerOptions).then((function(t){if(!e.destroyed){e.trickle||e.allowHalfTrickle||(t.sdp=d(t.sdp)),t.sdp=e.sdpTransform(t.sdp);var n=function(){if(!e.destroyed){var n=e._pc.localDescription||t;e.emit("signal",{type:n.type,sdp:n.sdp})}};e._pc.setLocalDescription(t).then((function(){e.destroyed||(e.trickle||e._iceComplete?n():e.once("_iceComplete",n))})).catch((function(t){e.destroy(t)}))}})).catch((function(t){e.destroy(t)}))}},{key:"_onConnectionStateChange",value:function(){this.destroyed||"failed"===this._pc.connectionState&&this.destroy(new Error("Connection failed."))}},{key:"_onIceStateChange",value:function(){if(!this.destroyed){var e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this.emit("iceStateChange",e,t),"connected"!==e&&"completed"!==e||(this._pcReady=!0,this._maybeReady()),"failed"===e&&this.destroy(new Error("Ice connection failed.")),"closed"===e&&this.destroy(new Error("Ice connection closed."))}}},{key:"getStats",value:function(e){var t=this,n=function(e){return"[object Array]"===Object.prototype.toString.call(e.values)&&e.values.forEach((function(t){Object.assign(e,t)})),e};0===this._pc.getStats.length||this._isReactNativeWebrtc?this._pc.getStats().then((function(t){var r=[];t.forEach((function(e){r.push(n(e))})),e(null,r)}),(function(t){return e(t)})):this._pc.getStats.length>0?this._pc.getStats((function(r){if(!t.destroyed){var i=[];r.result().forEach((function(e){var t={};e.names().forEach((function(n){t[n]=e.stat(n)})),t.id=e.id,t.type=e.type,t.timestamp=e.timestamp,i.push(n(t))})),e(null,i)}}),(function(t){return e(t)})):e(null,[])}},{key:"_maybeReady",value:function(){var e=this;if(!this._connected&&!this._connecting&&this._pcReady&&this._channelReady){this._connecting=!0;!function t(){e.destroyed||e.getStats((function(n,r){if(!e.destroyed){n&&(r=[]);var i={},o={},a={},s=!1;r.forEach((function(e){"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(i[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(o[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(a[e.id]=e)}));var u=function(t){s=!0;var n=o[t.localCandidateId];n&&(n.ip||n.address)?(e.localAddress=n.ip||n.address,e.localPort=Number(n.port)):n&&n.ipAddress?(e.localAddress=n.ipAddress,e.localPort=Number(n.portNumber)):"string"==typeof t.googLocalAddress&&(n=t.googLocalAddress.split(":"),e.localAddress=n[0],e.localPort=Number(n[1])),e.localAddress&&(e.localFamily=e.localAddress.includes(":")?"IPv6":"IPv4");var r=i[t.remoteCandidateId];r&&(r.ip||r.address)?(e.remoteAddress=r.ip||r.address,e.remotePort=Number(r.port)):r&&r.ipAddress?(e.remoteAddress=r.ipAddress,e.remotePort=Number(r.portNumber)):"string"==typeof t.googRemoteAddress&&(r=t.googRemoteAddress.split(":"),e.remoteAddress=r[0],e.remotePort=Number(r[1])),e.remoteAddress&&(e.remoteFamily=e.remoteAddress.includes(":")?"IPv6":"IPv4")};if(r.forEach((function(e){"transport"===e.type&&e.selectedCandidatePairId&&u(a[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&u(e)})),s||Object.keys(a).length&&!Object.keys(o).length){if(e._connecting=!1,e._connected=!0,e._chunk){try{e.send(e._chunk)}catch(n){return e.destroy(n)}e._chunk=null;var l=e._cb;e._cb=null,l(null)}"number"!=typeof e._channel.bufferedAmountLowThreshold&&(e._interval=setInterval((function(){return e._onInterval()}),150),e._interval.unref&&e._interval.unref()),e.emit("connect")}else setTimeout(t,100)}}))}()}}},{key:"_onInterval",value:function(){!this._cb||!this._channel||this._channel.bufferedAmount>f||this._onChannelBufferedAmountLow()}},{key:"_onSignalingStateChange",value:function(){var e=this;this.destroyed||("stable"===this._pc.signalingState&&(this._isNegotiating=!1,this._sendersAwaitingStable.forEach((function(t){e._pc.removeTrack(t),e._queuedNegotiation=!0})),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._queuedNegotiation=!1,this._needsNegotiation()):this.emit("negotiated")),this.emit("signalingStateChange",this._pc.signalingState))}},{key:"_onIceCandidate",value:function(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):e.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}},{key:"_onChannelMessage",value:function(e){if(!this.destroyed){var t=e.data;t instanceof ArrayBuffer&&(t=u.Buffer.from(t)),this.emit("data",t)}}},{key:"_onChannelBufferedAmountLow",value:function(){if(!this.destroyed&&this._cb){var e=this._cb;this._cb=null,e(null)}}},{key:"_onChannelOpen",value:function(){this._connected||this.destroyed||(this._channelReady=!0,this._maybeReady())}},{key:"_onChannelClose",value:function(){this.destroyed||this.destroy()}},{key:"bufferSize",get:function(){return this._channel&&this._channel.bufferedAmount||0}},{key:"connected",get:function(){return this._connected&&"open"===this._channel.readyState}},{key:"isBufferedAmountHigh",get:function(){return this._channel.bufferedAmount>f}}]),t}(a.default);h.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},h.channelConfig={},t.default=h,e.exports=t.default},931:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function r(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.peerMap=new Map}return n(e,[{key:"isEmpty",value:function(){return 0===this.peerMap.size}},{key:"size",value:function(){return this.peerMap.size}},{key:"clear",value:function(){this.peerMap.clear()}},{key:"getPeers",value:function(){return[].concat(r(this.peerMap.values()))}},{key:"getPeerValues",value:function(){return this.peerMap.values()}},{key:"hasPeer",value:function(e){return this.peerMap.has(e)}},{key:"addPeer",value:function(e,t){this.peerMap.set(e,t)}},{key:"getPeerIds",value:function(){return[].concat(r(this.peerMap.keys()))}},{key:"removePeer",value:function(e){this.peerMap.delete(e)}},{key:"getPeersOrderByWeight",value:function(){var e=this.getAvailablePeers();return e.sort((function(e,t){return 0===t.weight?1:0===e.weight?-1:t.weight-e.weight})),e}},{key:"getPeer",value:function(e){return this.peerMap.get(e)}},{key:"getAvailablePeers",value:function(){return this.getPeers().filter((function(e){return e.isAvailableUrgently}))}}]),e}();t.default=i,e.exports=t.default},542:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=h(n(746)),a=h(n(204)),s=h(n(784)),u=n(901),l=h(n(893)),c=h(n(206)),f=n(159),d=n(9);function h(e){return e&&e.__esModule?e:{default:e}}function p(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function g(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var v=64e3,_=function(e){function t(e,n,i,a,l,c){var f=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{};p(this,t);var d=g(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));d.engine=e,d.channel=e.fetcher.channelId,d.logger=e.logger,d.config=l,d.isInitiator=a,d.options=f,d.typeExpected=c,d.remotePeerId=i,d.intermediator=f.intermediator||null,d.channelId=a?n+"-"+i:i+"-"+n,d.cpr=0,d.platform="unknown",d.mobile=!1,d.mobileWeb=!1,d.connected=!1,d.msgQueue=[],d.miss=0,d.notifySet=new Set,d.bufArr=[],d.packetSize=v,d.connTimeout=setTimeout((function(){d.logger.warn("dc "+d.channelId+" connection timeout"),d.emit(s.default.DC_ERROR,!0)}),25e3),d.sendReqQueue=[],d.downloading=!1,d.uploading=!1,d.choked=!1,d.streamListeners=[],d.pieceMsg={},d.uploadInterrupter={targetSegId:void 0,currentSegId:void 0,canceled:!1},d.datasToSend=[],d.dataWriting=!1,d.timeSendRequest=0,d.timeReceivePiece=0,d.timeSendPiece=0,d.weight=0,d.peersConnected=1,d.timeJoin=(0,u.getCurrentTs)(),d.uploadSpeed=0,d.gotPeers=!1,d.currentLevel=0,d.currentPos=0;var h={};if(d.options.stuns.length>0){var _=[];d.options.stuns.forEach((function(e){d.logger.info("use stun "+e),_.push({urls:e})})),h.iceServers=_}return d.config.webRTCConfig&&(h=r({},d.config.webRTCConfig,h)),d.playlistMap=new Map,d._datachannel=new o.default({initiator:a,channelName:d.channelId,trickle:f.trickle||!1,config:h}),d._init(d._datachannel),d.dataExchangeTs=d.timeJoin,d.gotStatsTs=d.timeJoin,d.notFatalClosed=!1,d.startSN=Number.MAX_SAFE_INTEGER,d.endSN=-1,d._loadedBytes=0,d}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),i(t,null,[{key:"defaultPacketSize",get:function(){return v}},{key:"VERSION",get:function(){return"5"}}]),i(t,[{key:"cancelDownload",value:function(e,t,n){if(n&&this.downloading&&!(this.streamListeners.length>0||this.remainAttachments<=2))return this.logger.warn("cancel download "+n+" remain packets "+this.remainAttachments),this.sendJson({event:s.default.DC_PIECE_CANCEL,sn:e,level:t,seg_id:n})}},{key:"addStreamListener",value:function(e,t,n){this.streamListeners.push({handler:n,peerId:t})}},{key:"removeStreamListener",value:function(e){this.streamListeners=this.streamListeners.filter((function(t){return t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)}))}},{key:"_init",value:function(e){var t=this;e.on("error",(function(e){var n=!0;"Ice connection failed."===e.message&&t.notFatalClosed&&(n=!1),t.emit(s.default.DC_ERROR,n)})),e.on("signal",(function(e){if(1===t.cpr){var n=(0,f.pack)(e);n?e=n:t.logger.error("signal pack error")}t.emit(s.default.DC_SIGNAL,e)}));e.on("connect",(function(){for(t.logger.info("datachannel CONNECTED to "+t.remotePeerId+" from "+(t.intermediator?"peer":"server")),t.connected=!0,clearTimeout(t.connTimeout),t.emit(s.default.DC_OPEN);t.msgQueue.length>0;){var e=t.msgQueue.shift();t.emit(e.event,e)}})),e.on("data",(function(e){var n=t.logger;if("string"==typeof e){var r=JSON.parse(e);if(!t.connected)return void t.msgQueue.push(r);var i=r.event,o=void 0;switch(o=i!==s.default.DC_PLAYLIST&&i!==s.default.DC_PEER_SIGNAL?"string: "+e:"event: "+i,n.debug("datachannel receive "+o+" from "+t.remotePeerId),i){case s.default.DC_HAVE:if(t.emit(r.event,r),!r.sn)return;t.config.live||(r.sn<t.startSN&&(t.startSN=r.sn),r.sn>t.endSN&&(t.endSN=r.sn));break;case s.default.DC_PIECE:t.downloading=!0,t.dataExchangeTs=(0,u.getCurrentTs)(),t.timeReceivePiece=performance.now(),t.pieceMsg=r,t._prepareForBinary(r.attachments,r.seg_id,r.sn,r.size),t.emit(r.event,r);break;case s.default.DC_PIECE_CANCEL:t.uploadInterrupter.targetSegId=r.seg_id,t.emit(r.event,r);break;case s.default.DC_PIECE_NOT_FOUND:t._sendNextReq()||(t.downloading=!1),t.emit(r.event,r);break;case s.default.DC_REQUEST:t._handleRequestMsg(r);break;case s.default.DC_PIECE_ACK:t._handlePieceAck(r),t.emit(r.event,r);break;case s.default.DC_STATS:t._handleStats(r);break;case s.default.DC_PLAYLIST:t.config.sharePlaylist&&t._handlePlaylist(r);break;case s.default.DC_METADATA:t._handleMetadata(r);break;case s.default.DC_PIECE_ABORT:t.downloading&&(t._notifyDownloadListenersAbort("aborted by upstream peer"),t.emit(s.default.DC_PIECE_ABORT,r));break;case s.default.DC_CHOKE:n.info("choke peer "+t.remotePeerId),t.choked=!0;break;case s.default.DC_UNCHOKE:n.info("unchoke peer "+t.remotePeerId),t.choked=!1;break;case s.default.DC_CLOSE:t.emit(r.event,r.fatal||!1);break;default:t.emit(r.event,r)}}else{if(!t.downloading)return void n.warn("peer not downloading, data size "+e.byteLength+" pieceMsg "+JSON.stringify(t.pieceMsg));t._handleBinaryMsg(e)}})),e.once("close",(function(){t.emit(s.default.DC_CLOSE,!1)})),e.on("iceStateChange",(function(e,n){"disconnected"===e&&(t.logger.warn(t.remotePeerId+" disconnected"),t.connected=!1)}))}},{key:"sendJson",value:function(e){e.event!==s.default.DC_PLAYLIST&&e.event!==s.default.DC_PEER_SIGNAL?this.logger.debug("dc bufferSize "+this._datachannel.bufferSize+" send "+JSON.stringify(e)+" to "+this.remotePeerId):this.logger.debug("dc send event "+e.event+" to "+this.remotePeerId);var t=JSON.stringify(e);return t.length>v?(this.logger.error("string to send is too large"),!1):this.send(t,!1)}},{key:"send",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return t?(this.datasToSend.push(e),this.dataWriting||this._sendDataSync(),!0):this.sendImmediately(e)}},{key:"_checkIfNeedInterrupt",value:function(){var e=this.uploadInterrupter,t=e.targetSegId,n=e.currentSegId;return!!e.canceled||!(!t||t!==n)&&(this.logger.warn("cancel send data"),this.sendMsgPieceAbort(n+" transfer canceled"),this.datasToSend=[],this.uploadInterrupter.canceled=!0,!0)}},{key:"_sendDataSync",value:function(){var e=this;if(this._checkIfNeedInterrupt()||0===this.datasToSend.length)this.dataWriting=!1;else{this.dataWriting=!0;var t=this.datasToSend.shift();this._datachannel.write(t,(function(t){if(t)return e.dataWriting=!1,e.logger.warn(t.message),void e.emit(s.default.DC_ERROR,!1);e._sendDataSync()}))}}},{key:"sendImmediately",value:function(e){if(this._datachannel.connected)try{return this._datachannel.send(e),!0}catch(e){this.logger.warn("datachannel "+this.channelId+" send data failed, close it"),this.emit(s.default.DC_ERROR,!1)}return!1}},{key:"sendMsgHave",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=n.reverse||void 0;delete n.reverse,this.sendJson(r({event:i?s.default.DC_HAVE_REVERSE:s.default.DC_HAVE,sn:e,seg_id:t},n))}},{key:"sendPieceNotFound",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.uploading=!1,this.sendJson(r({event:s.default.DC_PIECE_NOT_FOUND,seg_id:t,sn:e},n))}},{key:"sendPeers",value:function(e){this.sendJson({event:s.default.DC_PEERS,peers:e})}},{key:"sendPeersRequest",value:function(){this.sendJson({event:s.default.DC_GET_PEERS})}},{key:"sendMsgStats",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r({event:s.default.DC_STATS,total_conns:e},t);this.sendJson(n)}},{key:"sendMsgPlaylist",value:function(e,t,n){if(this.playlistMap.has(e)&&this.playlistMap.get(e).seq>=n)return;var r={event:s.default.DC_PLAYLIST,url:e,data:t,seq:n};this.sendJson(r)}},{key:"sendMsgSignal",value:function(e,t,n){return this.sendJson({event:s.default.DC_PEER_SIGNAL,action:"signal",to_peer_id:e,from_peer_id:t,data:n})}},{key:"sendMsgSignalReject",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return this.sendJson({event:s.default.DC_PEER_SIGNAL,action:"reject",to_peer_id:e,from_peer_id:t,reason:n,fatal:r})}},{key:"sendMetaData",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.isInitiator&&(this.timeSendRequest=performance.now()),this.sendJson({event:s.default.DC_METADATA,field:e,platform:s.default.DC_PLAT_WEB,mobile:!!c.default.isMobile(),channel:this.channel,version:"1.20.10",sequential:t,peers:n})}},{key:"sendPartialBuffer",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.sendMsgPiece(e,n);for(var r=0;r<t.length;r++)this.send(t[r])}},{key:"sendMsgPiece",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this.uploadInterrupter.targetSegId;if(n&&n===e.seg_id)return this.logger.warn("cancel send piece msg"),this.sendMsgPieceAbort(n+" piece canceled"),void(this.uploadInterrupter.canceled=!0);this.uploadInterrupter={currentSegId:e.seg_id,targetSegId:void 0,canceled:!1},this.datasToSend=[],e.ext||(e.ext={}),e.ext.from&&t.from&&(t.from=e.ext.from+"->"+t.from),t.incompletes&&e.ext.incompletes&&(t.incompletes+=e.ext.incompletes),t=Object.assign({},e.ext,t);var i=r({},e,{ext:t});this.sendJson(i)}},{key:"sendBuffer",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=r.reverse||void 0;delete r.reverse;var o=n.byteLength,a=0,u=0;o%this.packetSize==0?u=o/this.packetSize:(u=Math.floor(o/this.packetSize)+1,a=o%this.packetSize);var l={event:s.default.DC_PIECE,attachments:u,seg_id:t,sn:e,level:r.level,size:o,reverse:i};delete r.level,this.sendMsgPiece(l,r);var c=y(n,this.packetSize,u,a);this._sendBufferArray(c,i),this.uploading=!1,this.timeSendPiece=performance.now()}},{key:"requestDataById",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=r({event:s.default.DC_REQUEST,seg_id:e,sn:t},i,{urgent:n});this.downloading?(this.logger.info(this.remotePeerId+" add req "+e+" in queue"),n?this.sendReqQueue.unshift(o):this.sendReqQueue.push(o)):this._realRequestData(o)}},{key:"requestDataBySN",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=r({event:s.default.DC_REQUEST,sn:e},n,{urgent:t});this.downloading?(this.logger.info("add req "+e+" in queue"),t?this.sendReqQueue.unshift(i):this.sendReqQueue.push(i)):this._realRequestData(i)}},{key:"_sendBufferArray",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=t?e.reverse():e,r=0;r<n.length;r++)this.send(n[r])}},{key:"_realRequestData",value:function(e){this.sendJson(e),this.timeSendRequest=performance.now(),this.downloading=!0}},{key:"shouldWaitForRemain",value:function(e){return 0!==this.bufArr.length&&(0!==this.timeReceivePiece&&this.currentLoadSpeed()>=this.minRequiredSpeed(e))}},{key:"close",value:function(e){e||(this.notFatalClosed=!0),this.emit(s.default.DC_CLOSE,e)}},{key:"receiveSignal",value:function(e){e.type||e.candidate||(this.cpr=1,e=(0,f.unpack)(e,this.cpr+"")),e&&this._datachannel.signal(e)}},{key:"_notifyDownloadListenersAbort",value:function(e){var t=!0,n=!1,r=void 0;try{for(var i,o=this.streamListeners[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){(0,i.value.handler)(void 0,void 0,!0,e)}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}this.streamListeners=[]}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.logger.info("destroy datachannel "+this.channelId),this.chokeTimer&&clearTimeout(this.chokeTimer),this.connTimeout&&clearTimeout(this.connTimeout),this.uploading&&this.sendMsgPieceAbort("peer is closing"),this._notifyDownloadListenersAbort("upstream peer is closed");var t={event:s.default.DC_CLOSE,fatal:e};this.sendJson(t),this._datachannel.removeAllListeners(),this.removeAllListeners(),this._datachannel.destroy(),this.engine=null}},{key:"_handleBinaryMsg",value:function(e){var t=this.pieceMsg,n=t.attachments,r=t.level,i=t.reverse;this.bufArr.push(e),this._loadedBytes+=e.byteLength,this.remainAttachments--;var o=i?this.remainAttachments+1:n-this.remainAttachments,a=0===this.remainAttachments;if(a&&(this._sendNextReq()||(this.downloading=!1)),this.emit(s.default.DC_PIECE_DATA,this.bufSN,this.segId,e,o,a,this.pieceMsg),this.streamListeners.length>0){var u=!0,l=!1,c=void 0;try{for(var f,d=this.streamListeners[Symbol.iterator]();!(u=(f=d.next()).done);u=!0){(0,f.value.handler)(this.bufSN,this.segId,!1,e,a)}}catch(e){l=!0,c=e}finally{try{!u&&d.return&&d.return()}finally{if(l)throw c}}}if(a){if(this.streamListeners=[],this.timeSendRequest>0){var h=this.expectedSize/(performance.now()-this.timeSendRequest);this.weight=this.weight>0?.6*this.weight+.4*h:h}this.sendJson({event:s.default.DC_PIECE_ACK,sn:this.bufSN,seg_id:this.segId,level:r,size:this.expectedSize,miss:this.miss||void 0}),this.timeSendRequest=0,this.timeReceivePiece=0,this._handleBinaryData(i)}}},{key:"_sendNextReq",value:function(){if(this.sendReqQueue.length>0){var e=this.sendReqQueue.shift();return this.logger.info("get msg from sendReqQueue "+JSON.stringify(e)),this._realRequestData(e),!0}return!1}},{key:"_handlePlaylist",value:function(e){var t=e.url,n=e.data,r=e.seq;this.playlistMap.set(t,{data:n,seq:r})}},{key:"getLatestPlaylist",value:function(e,t){if(!this.playlistMap.has(e))return null;var n=this.playlistMap.get(e);return n.seq<=t?null:n}},{key:"_handleMetadata",value:function(e){var t=this.logger;if(this.isInitiator){var n=performance.now()-this.timeSendRequest;n>0&&(this.weight=1e5/n,t.info("handle Metadata from "+this.remotePeerId+" initial weight "+this.weight)),this.timeSendRequest=0}var r=e.channel;if(!r)return t.error("peer channel "+r+" is null!"),void this.emit(s.default.DC_ERROR,!0);if(this.channel!==r)return t.error("peer channel "+r+" not matched!"),void this.emit(s.default.DC_ERROR,!0);switch(e.platform){case s.default.DC_PLAT_ANDROID:this.platform=s.default.DC_PLAT_ANDROID;break;case s.default.DC_PLAT_IOS:this.platform=s.default.DC_PLAT_IOS;break;case s.default.DC_PLAT_WEB:this.platform=s.default.DC_PLAT_WEB}if(this.mobile=e.mobile||!1,this.mobileWeb=this.mobile&&this.platform===s.default.DC_PLAT_WEB||!1,this.sequential=e.sequential,this.sequential!==this.typeExpected)return t.error("peer sequential type "+this.sequential+" not matched!"),void this.emit(s.default.DC_ERROR,!0);if(t.info(this.remotePeerId+" platform "+this.platform+" sequential "+this.sequential),e.peers&&(this.peersConnected+=e.peers,t.info(this.remotePeerId+" now has "+this.peersConnected+" peers")),this.emit(s.default.DC_METADATA,e),e.field&&!this.config.live&&e.sequential){var i=e.field;if(Array.isArray(i))this._handleField(i);else for(var o in i)this._handleField(i[o])}}},{key:"_handleField",value:function(e){var t=this;e.forEach((function(e){e>=0&&(e<t.startSN&&(t.startSN=e),e>t.endSN&&(t.endSN=e))}))}},{key:"_handleStats",value:function(e){this.gotStatsTs=(0,u.getCurrentTs)();var t=e.total_conns;t>0&&this.peersConnected!==t&&(this.peersConnected=t,this.logger.info(this.remotePeerId+" now has "+this.peersConnected+" peers")),e.level&&(this.currentLevel=e.level),e.pos&&(this.currentPos=e.pos)}},{key:"_handleRequestMsg",value:function(e){this.dataExchangeTs=(0,u.getCurrentTs)(),this.uploading?this.logger.warn(this.remotePeerId+" is uploading when receive request"):(this.uploading=!0,this.emit(s.default.DC_REQUEST,e))}},{key:"_handlePieceAck",value:function(e){0!==this.timeSendPiece&&(this.uploadSpeed=Math.round(e.size/(performance.now()-this.timeSendPiece)*2),this.timeSendPiece=0,this.logger.info(this.remotePeerId+" uploadSpeed is "+this.uploadSpeed)),e.miss>0&&this.logger.warn("peer "+this.remotePeerId+" miss "+e.miss)}},{key:"_prepareForBinary",value:function(e,t,n,r){this.bufArr=[],this._loadedBytes=0,this.remainAttachments=e,this.segId=t,this.bufSN=n,this.expectedSize=r}},{key:"_handleBinaryData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.listenerCount(s.default.DC_RESPONSE)>0){e&&this.bufArr.reverse();var t=d.Buffer.concat(this.bufArr),n=t.byteLength;if(n===this.expectedSize){var r=t.buffer,i=new l.default(this.bufSN,this.segId,r,this.remotePeerId,this.pieceMsg.level);this.emit(s.default.DC_RESPONSE,i,this.weight)}else this.logger.error(this.segId+" expectedSize "+this.expectedSize+" != byteLength "+n)}this.segId="",this.bufArr=[],this._loadedBytes=0,this.expectedSize=-1}},{key:"checkIfNeedChoke",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=this.logger,r=performance.now()-this.timeSendRequest;if(!t&&r<1500)n.info("duration "+r+" no need choke");else if(this.miss++,n.info(this.remotePeerId+" miss "+this.miss),this.miss>2&&!this.choked){this.choked=!0;var i=30*this.miss;i<=150?(n.warn("datachannel "+this.channelId+" is choked"),this.chokeTimer=setTimeout((function(){e.choked=!1,n.warn("datachannel "+e.channelId+" is unchoked")}),1e3*i)):n.warn("datachannel "+this.channelId+" is choked permanently")}}},{key:"loadtimeout",value:function(){var e=this.logger,t=this.bufArr,n=this.pieceMsg;return e.warn("timeout while downloading from "+this.remotePeerId+", "+t.length+" of "+n.attachments+" packets loaded"),this.emit(s.default.DC_TIMEOUT),this.checkIfNeedChoke(),!0}},{key:"sendMsgPieceAbort",value:function(e){(this.uploading||0!==this.datasToSend.length)&&(this.uploading=!1,this.sendJson({event:s.default.DC_PIECE_ABORT,reason:e}))}},{key:"loadedBytes",value:function(){return this._loadedBytes}},{key:"currentLoadSpeed",value:function(){return 0===this.timeReceivePiece?0:this.loadedBytes()/(performance.now()-this.timeReceivePiece)}},{key:"minRequiredSpeed",value:function(e){return(this.pieceMsg.size-this.loadedBytes())/e}},{key:"isAvailable",get:function(){return this.downloadNum<2&&!this.choked}},{key:"isAvailableUrgently",get:function(){return!this.downloading&&!this.choked}},{key:"downloadNum",get:function(){return this.downloading?this.sendReqQueue.length+1:0}}]),t}(a.default);function y(e,t,n,r){var i=[];if(r){for(var o=void 0,a=0;a<n-1;a++)o=e.slice(a*t,(a+1)*t),i.push(o);o=e.slice(e.byteLength-r,e.byteLength),i.push(o)}else for(var s=void 0,u=0;u<n;u++)s=e.slice(u*t,(u+1)*t),i.push(s);return i}t.default=_,e.exports=t.default},356:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var r=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.internalMap=new Map}return n(e,[{key:"has",value:function(e){return this.internalMap.has(e)}},{key:"set",value:function(e,t){if(this.internalMap.has(e)){var n=this.internalMap.get(e);if(n&&!n.includes(t))return void n.push(t)}this.internalMap.set(e,[t])}},{key:"setPeerUnknown",value:function(e){this.internalMap.set(e,null)}},{key:"checkIfPeerUnknown",value:function(e){return this.internalMap.has(e)&&!this.internalMap.get(e)}},{key:"getAllPeerIds",value:function(e){var t=this.internalMap.get(e);return t||[]}},{key:"get",value:function(e){return this.getOnePeerId(e)}},{key:"getOnePeerId",value:function(e){if(this.internalMap.has(e)&&this.internalMap.get(e))return this.internalMap.get(e)[0];return null}},{key:"delete",value:function(e){this.internalMap.delete(e)}},{key:"clear",value:function(){this.internalMap.clear()}}]),e}();t.default=r,e.exports=t.default},934:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=l(n(204)),o=l(n(784)),a=l(n(931)),s=n(901),u=n(949);function l(e){return e&&e.__esModule?e:{default:e}}var c=Symbol("shareOnly"),f=function(e){function t(e,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.engine=e,r.config=n,r.logger=e.logger,r.bufMgr=null,r.peerManager=new a.default,r._setupEngine&&r._setupEngine(),r.startCheckConnsTimer(),r.dcDownloadTimeout=n.dcDownloadTimeout,r[c]=!1,r.downloadOnly=!1,r.loadedPeerNum=0,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"startCheckConnsTimer",value:function(){var e=this;this.checkConnsTimer=setInterval((function(){e.logger.info("start check conns");var t=e.getStatsForPeer(),n=e.peersNum,r=(0,s.getCurrentTs)();e.getPeers().forEach((function(i){n>4&&(r-i.dataExchangeTs>240||r-i.gotStatsTs>=83)?(e.logger.warn("close dead or different level peer "+i.remotePeerId+" level "+i.currentLevel),i.close(!1),n--):i.connected&&i.sendMsgStats(n,t)}))}),4e4)}},{key:"getStatsForPeer",value:function(){return{}}},{key:"getNonactivePeers",value:function(){var e=(0,s.getCurrentTs)();return this.getPeers().filter((function(t){return e-t.dataExchangeTs>240})).sort((function(e,t){return e.dataExchangeTs-t.dataExchangeTs}))}},{key:"requestPeers",value:function(){this.logger.info("request peers from peers");var e={event:o.default.DC_GET_PEERS};this._broadcastToPeers(e)}},{key:"chokePeerRequest",value:function(e){var t={event:o.default.DC_CHOKE};e?e.sendJson(t):this._broadcastToPeers(t)}},{key:"unchokePeerRequest",value:function(e){var t={event:o.default.DC_UNCHOKE};e?e.sendJson(t):this._broadcastToPeers(t)}},{key:"stopRequestFromPeers",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,i=this.peerManager.getPeerValues()[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){r.value.choked=!0}}catch(e){t=!0,n=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw n}}}},{key:"resumeRequestFromPeers",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,i=this.peerManager.getPeerValues()[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){r.value.choked=!1}}catch(e){t=!0,n=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw n}}}},{key:"setShareOnly",value:function(){this[c]=!0}},{key:"deletePeer",value:function(e){this.peerManager.hasPeer(e.remotePeerId)&&this.peerManager.removePeer(e.remotePeerId),this._peersStats(this.peerManager.getPeerIds())}},{key:"getPeers",value:function(){return[].concat(function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(this.peerManager.getPeerValues()))}},{key:"addPeer",value:function(e){var t=this.logger;this.peerManager.addPeer(e.remotePeerId,e),this[c]&&(e.choked=!0);var n=this.peerManager.getPeerIds();this._peersStats(n),t.info("add peer "+e.remotePeerId+", now has "+n.length+" peers"),e.isInitiator&&this.peersNum<=5&&e.peersConnected>1&&e.sendPeersRequest()}},{key:"getIdlePeer",value:function(){return this.peerManager.getAvailablePeers()}},{key:"onBufferManagerSegAdded",value:function(e){}},{key:"destroy",value:function(){var e=this.logger;this.peersNum>0&&this.peerManager.clear(),this.removeAllListeners(),clearInterval(this.checkConnsTimer),this.checkTimer&&this.checkTimer.cancel(),e.warn("destroy BtScheduler")}},{key:"notifyPeersLoaded",value:function(e){}},{key:"_setupDC",value:function(e){var t=this,n=this.logger;e.on(o.default.DC_PIECE_ACK,(function(r){r.size&&t.engine.fetcher.reportUploaded(r.size),n.info("uploaded "+r.seg_id+" to "+e.remotePeerId)})).on(o.default.DC_TIMEOUT,(function(e){})).on(o.default.DC_PIECE_ABORT,(function(r){n.warn("peer "+e.remotePeerId+" download aborted, reason "+r.reason),e.downloading&&t._handlePieceAborted&&t._handlePieceAborted(e.remotePeerId),e.downloading=!1}))}},{key:"_broadcastToPeers",value:function(e){var t=!0,n=!1,r=void 0;try{for(var i,o=this.peerManager.getPeerValues()[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){i.value.sendJson(e)}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}}},{key:"_peersStats",value:function(e){this.engine.emit("peers",e);var t=this.engine.config.getPeersInfo;t&&"function"==typeof t&&t(e)}},{key:"startCheckPeersTimer",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3e3;this.checkTimer=(0,u.createTimeoutGenerator)(),this.checkTimer.start((function(t){e.checkPeers();var n=1e3*(0,s.calCheckPeersDelay)(e.loadedPeerNum);e.logger.info("loaded peers "+e.loadedPeerNum+" nextDelay "+n),e.loadedPeerNum=0,t(n)}),t)}},{key:"hasPeers",get:function(){return this.peersNum>0}},{key:"peersNum",get:function(){return this.peerManager.size()}},{key:"hasIdlePeers",get:function(){var e=this.logger,t=this.getIdlePeer().length;if(e.info("peers: "+this.peersNum+" idle peers: "+t),t<this.peersNum){var n=this.peerManager.getPeers(),r=n.filter((function(e){return e.downloading}));e.warn("downloading: "+r.length+" choked: "+n.filter((function(e){return e.choked})).length);var i=!0,o=!1,a=void 0;try{for(var s,u=r[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value;e.warn(l.remotePeerId+" loading "+l.segId+" packets "+l.bufArr.length+" total "+l.pieceMsg.attachments)}}catch(e){o=!0,a=e}finally{try{!i&&u.return&&u.return()}finally{if(o)throw a}}}return t>0}},{key:"bufferManager",set:function(e){var t=this;this.bufMgr=e,e.on(o.default.BM_LOST,(function(e){var n=e.sn,r=e.segId,i=e.next,a=e.level;t.config.live||t._broadcastToPeers({event:o.default.DC_LOST,sn:n,seg_id:r,level:a||void 0}),t.onBufferManagerLost(n,r,i,a)})).on(o.default.BM_SEG_ADDED,(function(e){t.onBufferManagerSegAdded(e)}))}}]),t}(i.default);t.default=f,e.exports=t.default},159:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unpack=t.pack=void 0;var r=o(n(254)),i=o(n(551));function o(e){return e&&e.__esModule?e:{default:e}}t.pack=r.default,t.unpack=i.default},254:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var t=e.type,n=e.sdp,o=e.candidate;return n&&n.startsWith("v=0")?function(e,t){var n=void 0,o=void 0,a=void 0,s=[],u=!1,l=!1,c=!0,f=!1,d=void 0;try{for(var h,p=t.split("\r\n")[Symbol.iterator]();!(c=(h=p.next()).done);c=!0){var g=h.value,v=g.indexOf(":");if(!(v<=0))if("a=ice-options:trickle"!==g){var _=[g.slice(0,v),g.slice(v+1).trim()],y=_[0],b=_[1];switch(y){case"a=ice-ufrag":n=b;break;case"a=ice-pwd":o=b;break;case"a=fingerprint":a=(0,r.bytesToStr)(b.substr("sha-256".length).trim().split(":").map((function(e){return parseInt(e,16)})));break;case"a=candidate":var m=i(b);if(!m)continue;if(m.local){if(u)continue;u=!0}s.push(m.cand)}}else l=!0}}catch(e){f=!0,d=e}finally{try{!c&&p.return&&p.return()}finally{if(f)throw d}}return(0,r.sdpType2Char)(e,l)+a+(s.length>0?s.join(r.arrayDelimiter):"")+(l?"":r.delimiter)+n+r.delimiter+o}(t,n):"candidate"===t&&o?function(e){var t=e.indexOf(":");if(t<=0)return null;var n=i(e.slice(t+1).trim());return n?(0,r.sdpType2Char)("candidate")+n.cand:null}(o.candidate):null};var r=n(957);function i(e){var t=!1,n=(0,r.parseCand)(e);if("TCP"===n.transport)return null;n.ip.endsWith(".local")&&(t=!0);var i=n.type.charAt(0),o=n.ip.split(".");if(4===o.length){var a=o.reduce((function(e,t){return(e<<8)+parseInt(t,10)}));i=""+i+n.foundation+" "+a+":"+parseInt(n.port)}else i=""+i+n.foundation+" "+n.ip+" "+n.port;return{cand:i,local:t}}e.exports=t.default},551:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};t.default=function(e,t){var n=(0,i.char2SdpType)(e.substr(0,1));return n?"candidate"===n.type?function(e){var t=o(e.substr(1),100);return t?{type:"candidate",candidate:{candidate:"candidate:"+t,sdpMLineIndex:0,sdpMid:"0"}}:null}(e):function(e,t,n,a){var s=(0,i.strToBytes)(n.slice(1,33)).map((function(e){return("0"+e.toString(16)).slice(-2)})),u=n.substr(33),l=void 0,c=void 0,f=void 0;if(a){var d=u.split(i.delimiter),h=r(d,2);c=h[0],f=h[1]}else{var p=u.split(i.delimiter),g=r(p,3);l=g[0],c=g[1],f=g[2]}var v=a?[]:l.split(i.arrayDelimiter),_=["v=0","o=- "+t+" 2 IN IP4 127.0.0.1","s=-","t=0 0","a=group:BUNDLE 0","a=msid-semantic: WMS","m=application 9 UDP/DTLS/SCTP webrtc-datachannel","c=IN IP4 0.0.0.0","a=mid:0","a=sctp-port:5000","a=setup:"+("answer"===e?"active":"actpass"),"a=ice-ufrag:"+c,"a=ice-pwd:"+f,"a=fingerprint:sha-256 "+s.join(":").toUpperCase()];a&&_.push("a=ice-options:trickle");var y=100,b=!0,m=!1,w=void 0;try{for(var P,S=v[Symbol.iterator]();!(b=(P=S.next()).done);b=!0){var C=o(P.value,y);C&&(y--,_.push("a=candidate:"+C))}}catch(e){m=!0,w=e}finally{try{!b&&S.return&&S.return()}finally{if(m)throw w}}return{type:e,sdp:_.join("\r\n")+"\r\n"}}(n.type,t,e,n.trickle):null};var i=n(957);function o(e,t){var n=void 0,o=void 0,a=void 0,s=i.candTypeMap[e.substr(0,1)],u=e.substr(1).split(" ");if(2===u.length){a=u[0];var l=u[1].split(":");n=[l[0]>>24&255,l[0]>>16&255,l[0]>>8&255,255&l[0]].join("."),o=l[1]}else{var c=r(u,3);a=c[0],n=c[1],o=c[2]}return""+[a,1,"udp",t,n,o,"typ",s].join(" ")}e.exports=t.default},957:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};t.parseCand=function(e){var t=/(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: ufrag (\S*))?(?: network-id (\d*))?(?: network-cost (\d*))?/.exec(e),r=n(t,15),i=r[1],o=r[2],a=r[3],s=r[4],u=r[5],l=r[6],c=r[7],f=r[8],d=r[9],h=r[10],p=r[11],g=r[12],v=r[13],_=r[14];return{foundation:i,component:o,transport:a,priority:s,ip:u,port:l,type:c,raddr:f,rport:d,tcptype:h,generation:p,networkId:v,networkCost:_,ufrag:g}};t.delimiter="|",t.arrayDelimiter=",",t.candTypeMap={h:"host",s:"srflx",p:"prflx",r:"relay"},t.sdpType2Char=function(e,t){var n=void 0;switch(e){case"candidate":n="c";break;case"offer":n=t?"q":"o";break;case"answer":n=t?"s":"a"}return n},t.char2SdpType=function(e){var t={};switch(e){case"o":t={type:"offer"};break;case"q":t={type:"offer",trickle:!0};break;case"a":t={type:"answer"};break;case"s":t={type:"answer",trickle:!0};break;case"c":t={type:"candidate",trickle:!0}}return t},t.bytesToStr=function e(t){return"number"==typeof t?e([t]):String.fromCharCode.apply(String,function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(t.map((function(e){return e+0}))))},t.strToBytes=function(e){return e.split("").map((function(e){return e.charCodeAt(0)-0}))}},23:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=s(n(204)),o=s(n(784)),a=s(n(206));function s(e){return e&&e.__esModule?e:{default:e}}function u(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var f=36700160,d=function(e){function t(e,n){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];l(this,t);var i=c(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));i.isSequential=r,i.logger=n.logger;var o=e.browserInfo.device;return i.maxBufSize=o===a.default.device.PC_WEB||o===a.default.device.PC_NATIVE?n.memoryCacheLimit.pc:n.memoryCacheLimit.mobile,n.live&&(i.maxBufSize=f),i._segPool=new Map,i._currBufSize=0,i.id2Sn=new Map,i.overflowed=!1,i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"hasSegOfId",value:function(e){if(this.isSequential){var t=this.id2Sn.get(e);return this._segPool.has(t)}return this._segPool.has(e)}},{key:"hasSegOfSN",value:function(e){return!!this.isSequential&&this._segPool.has(e)}},{key:"_calSegPoolSize",value:function(){var e=0;return this._segPool.forEach((function(t){e+=t.size})),e}},{key:"putSeg",value:function(e){if(this._currBufSize>=1.5*this.maxBufSize&&(this._currBufSize=this._calSegPoolSize(),this._currBufSize>=1.5*this.maxBufSize&&(this.clear(),this.overflowed=!1)),this.isSequential){if(this._segPool.has(e.sn))return;this._addSequentialSeg(e)}else{if(this._segPool.has(e.segId))return;this._addUnsequentialSeg(e)}}},{key:"_addSequentialSeg",value:function(e){var t=this.logger,n=e.segId,r=e.sn,i=e.size;this.id2Sn.set(n,r),this._segPool.set(r,e),this._currBufSize+=parseInt(i);var a=this._segPool.size;if(this.emit(""+o.default.BM_ADDED_SN_+e.sn,e),this.emit(o.default.BM_SEG_ADDED,e),!(this._currBufSize<this.maxBufSize||a<=5)){var s=Array.from(this._segPool.keys()).sort((function(e,t){return e-t})),u=0;do{if(u++>10){console.error("too much loops in SegmentCache");break}var l=s.shift();if(void 0!==l){var c=s[0],f=this._segPool.get(l);if(f){var d=f.size;this._currBufSize-=parseInt(d),this._segPool.delete(l),this.id2Sn.delete(f.segId),t.info("pop seg "+l+" size "+d+" currBufSize "+this._currBufSize),this.overflowed||(this.overflowed=!0),this.emit(o.default.BM_LOST,{sn:l,segId:f.segId,next:c,level:f.level})}else t.error("lastSeg not found")}else t.error("lastSN not found")}while(this._currBufSize>=this.maxBufSize&&this._segPool.size>5)}}},{key:"_addUnsequentialSeg",value:function(e){var t=this.logger,n=e.segId,r=e.size;this._segPool.set(n,e),this._currBufSize+=parseInt(r),this.emit(""+o.default.BM_ADDED_SEG_+e.segId,e),this.emit(o.default.BM_SEG_ADDED,e);for(var i=0;this._currBufSize>=this.maxBufSize&&this._segPool.size>5;){if(i++>10){console.error("too much loops in SegmentCache");break}var a=[].concat(u(this._segPool.values())).shift(),s=a.segId,l=a.size;this._currBufSize-=parseInt(l),t.info("pop seg "+s+" size "+l),this._segPool.delete(s),this.overflowed||(this.overflowed=!0),this.emit(o.default.BM_LOST,{sn:-1,segId:s,level:a.level})}}},{key:"getSegById",value:function(e){if(this.isSequential){var t=this.id2Sn.get(e);return this._segPool.get(t)}return this._segPool.get(e)}},{key:"getSegIdBySN",value:function(e){var t=this._segPool.get(e);return t?t.segId:null}},{key:"getSegBySN",value:function(e){if(this.isSequential)return this._segPool.get(e);throw new Error("fatal error in SegmentCache")}},{key:"clear",value:function(){this.logger.warn("clear segment cache"),this._segPool.clear(),this.id2Sn.clear(),this._currBufSize=0}},{key:"destroy",value:function(){this.clear(),this.removeAllListeners()}},{key:"currBufSize",get:function(){return this._currBufSize}}]),t}(i.default);t.default=d,e.exports=t.default},893:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(t,n,i,o){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;r(this,e),this.sn=t,this.segId=n,this.data=i,this.fromPeerId=o,this.level=a||0}return n(e,[{key:"size",get:function(){return this.data.byteLength}},{key:"isSequential",get:function(){return this.sn>=0}}],[{key:"fromSegment",value:function(t){return new e(t.sn,t.segId,t.data,t.fromPeerId,t.level)}}]),e}();t.default=i,e.exports=t.default},702:(module,exports,__webpack_require__)=>{"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_md=__webpack_require__(66),_md2=_interopRequireDefault(_md),_urlToolkit=__webpack_require__(622),_urlToolkit2=_interopRequireDefault(_urlToolkit),_events=__webpack_require__(784),_events2=_interopRequireDefault(_events),_toolFuns=__webpack_require__(901),_platform=__webpack_require__(206),_errCode=__webpack_require__(522),_errCode2=_interopRequireDefault(_errCode),_storage=__webpack_require__(156);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var MIN_CONNS=8,BASE_REPORT_INTERVAL=20,IPAPI_URL="//pro.ip-api.com/json?fields=2181826&key=XOpiansRgYxGTho",IPAPI_TIMEOUT=600,GEOIP_KEY="SW_GEOIP_KEY",GEOIP_EXPIRATION=2592e5,GEOIP_EXPIRATION_MOBILE=432e5,URL_MAP={q:"uZ2luZS5u",v:"Y24u",3:"Y2Ru",0:"yMzMzL2Js",l:"Nvb",zz:"aHR0cHMlM",n:"YnllLm",h:"ZXQlM0E",7:"Q==",df:"0EvL",6:"3AycGV",x:"aGsuc3d",kj:"dHJhY",a:"2tlci5","+":"oZHR2","=":"Y2xvdW",w:"QuY29t","{":"3ZWIz","?":"LWxhY",$:"i5jb20=",o:"hcm1j",xo:"bG91ZC",sb:"5uZXQ="},_httpDownloaded=Symbol("httpDownloaded"),_p2pDownloaded=Symbol("p2pDownloaded"),_p2pUploaded=Symbol("p2pUploaded"),Server=function(){function Server(e,t,n,r,i){_classCallCheck(this,Server);var o=void 0;switch(e.config.announceLocation){case"cn":o=URL_MAP.v+URL_MAP[3]+URL_MAP.n+URL_MAP.l+URL_MAP[7];break;case"hk":o=URL_MAP.x+URL_MAP.o+URL_MAP.xo+URL_MAP.sb;break;case"us":o=URL_MAP.kj+URL_MAP.a+URL_MAP["+"]+URL_MAP["="]+URL_MAP.w;break;case"eu":o=URL_MAP.kj+URL_MAP.a+URL_MAP["{"]+URL_MAP["?"]+URL_MAP.$}this.engine=e,this.key=t||void 0,this.baseUrl=r||"https://"+window.atob(o)+"/v1",this.channelId=window.btoa(n),this.timestamp=(0,_toolFuns.getCurrentTs)();var a=_urlToolkit2.default.parseURL(this.baseUrl).netLoc;this.announce=a.replace(/\/\//,"");var s=genV(this.timestamp,"1.20.10",this.announce,this.channelId,i.type);this.native=!!i.bundle,this.announceInfo=_extends({},i,{channel:this.channelId,ts:this.timestamp,version:"1.20.10",v:s,announce:this.announce,token:(0,_platform.isLocalHost)()&&!this.native?void 0:this.key}),this.announceURL=this.baseUrl+"/channel",this.reportFails=0,this.forbidden=!1,this.failConns=0,this.totalHTTPDownloaded=0,this.totalP2PDownloaded=0,this.totalP2PUploaded=0,this[_httpDownloaded]=0,this[_p2pDownloaded]=0,this[_p2pUploaded]=0,this.speed=0,this.offline=!1,this.errsBufStalled=0,this.mediaRequests=0,this.errsInternalExpt=0}return _createClass(Server,[{key:"geoipRequest",value:function(){var e=this.engine.logger;return new Promise((function(t,n){if((0,_storage.hasItemUnexpired)(GEOIP_KEY)){var r=(0,_storage.getItem)(GEOIP_KEY);e.info("found local geo data"),t(r)}else fetch(IPAPI_URL).then((function(e){return e.json()})).then((function(e){if("success"===e.status){var r=e.mobile?GEOIP_EXPIRATION_MOBILE:GEOIP_EXPIRATION;(0,_storage.setItemWithExpiration)(GEOIP_KEY,e,r),t(e)}else{var i=new Error("preflight status "+e.status);n((0,_errCode2.default)(i,"IPAPI_ERROR"))}})).catch((function(e){n(e)}))}))}},{key:"btAnnouncePreflight",value:function(){var e=this,t=this.engine.logger;return this.announceInfo.asn?this.btAnnounce():(t.info("preflight ip-api"),Promise.race([this.geoipRequest(),new Promise((function(e,t){setTimeout((function(){t((0,_errCode2.default)(new Error("request timeout"),"IPAPI_ERROR"))}),IPAPI_TIMEOUT)}))]).then((function(t){return e._parseGeoResponse(t),e.btAnnounce()})).catch((function(n){if("TRACKER_EXPT"!==n.code){var r=(0,_storage.getItem)(GEOIP_KEY);return r&&(t.info("use expired ipData"),e._parseGeoResponse(r)),e.btAnnounce()}throw n})))}},{key:"_parseGeoResponse",value:function(e){var t=e.lat,n=e.lon,r=e.isp,i=e.as,o=e.mobile,a=e.countryCode,s=e.continentCode;o&&(this.announceInfo.netType="cellular");var u=i.split(" ")[0].substr(2);this.announceInfo.tag||(this.announceInfo.tag=(s||"")+"-"+(0,_platform.getBrowser)()+((0,_toolFuns.isHttps)()?"s":"")),this.announceInfo=_extends({},this.announceInfo,{lat:t,lon:n,isp:r,asn:u,country:a})}},{key:"btAnnounce",value:function(){var e=this,t=this.engine.logger;return this.announceInfo.tag||(this.announceInfo.tag=(0,_platform.getBrowser)()+((0,_toolFuns.isHttps)()?"s":"")),new Promise((function(n,r){fetch(e.announceURL,{headers:e._requestHeader,method:"POST",body:JSON.stringify(e.announceInfo)}).then((function(e){return e.json()})).then((function(t){e.engine||r((0,_errCode2.default)(new Error("runtime error"),"TRACKER_EXPT",{retry:!1}));var i=t.data;if(i.f&&(e.forbidden=!0),-1===t.ret){var o=t.data,a=o.code,s=o.msg;r((0,_errCode2.default)(new Error(s),"TRACKER_EXPT",{retry:a>=5e3}))}else i.info&&console.info(""+i.info),i.warn&&console.warn(""+i.warn),i.min_conns||(i.min_conns=MIN_CONNS),(!i.rejected||i.rejected&&i.share_only)&&i.id&&i.report_interval&&i.peers?(e.peerId=e.id=i.id,i.report_interval<BASE_REPORT_INTERVAL&&(i.report_interval=BASE_REPORT_INTERVAL),e.btStats(i.report_interval),e.getPeersURL=e.baseUrl+"/channel/"+e.channelId+"/node/"+e.peerId+"/peers",e.statsURL=e.baseUrl+"/channel/"+e.channelId+"/node/"+e.peerId+"/stats",n(i)):(e.engine&&(e.engine.p2pEnabled=!1),r((0,_errCode2.default)(new Error("msg not valid"),"TRACKER_EXPT",{retry:!1})))})).catch((function(e){t.error("btAnnounce error "+e),r((0,_errCode2.default)(e,"TRACKER_EXPT",{retry:!0}))}))}))}},{key:"btStats",value:function btStats(){var _this4=this,interval=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,_this=this;this.heartbeater=setInterval((function(){_this4.postStats(),_b(interval)}),1e3*interval);var _0x5bd5=["v1","PmvWt1ORKFVimMIwnGl==","wpUsdEvDhA==","eC3CqcOrQ8KQRMKK","HUEHO8OWMcKWw5M=","ZxfChcKtEg==","DcOIVgXDtQ==","CwbCicO9woI=","wpfCo3VewrY=","w4c+w7JXw7Y=","TFt/wo3CsA==","X8ONKcKCw74=","w4PCoMO/eg4=","N2Upwoow","fMKDccOGw5o=","RcKlXcOUw64=","wpnCl8OHAMKd","A8OTwrHCpWk=","wr3DhVM=","AcOVVS/DosO8wo/ClA==","w4PChcOl","dcO0TMKZEsO6w5XCscKMSDDDmg==","w7otSDDDkMOOLQ==","wqTCmsKMw6zCgw==","Dlg5DMO3","b8KJJFzDl8OLw7TDow==","w7gnaTfDi8OILRw=","d3l/wqE=","BGsww7hG","wojClsKHw5HCsg==","QcOJRm3DlA==","ecKaScOKw6c=","w5bCq8Oj","w4dTw61e","w4zCqMOQfMOA","wr8ORHXDog==","wrzCkcOmNsKb","w4E4w41R","Vj7CscKgAg==","T8OLLMOGCQ==","c8Krw67CoRI=","e8OjQcKBwqc=","w4oNwqtbwoM=","W8OQR8K0Ng==","DsO6w6nDl8Ki","V8O/ZMK0Jg==","NgbCvcOpwqo=","EV8hAMOi","wp/CjU7Ch8Kj","wo/CiUbClsKFGi9ew4rDtA==","WcKHLUbDkQ==","cMOLw5vCkBo="],_0x3eee5c,_0x2b2808;_0x3eee5c=_0x5bd5,_0x2b2808=343,function(e,t,n,r){if((t>>=8)<e){for(;--e;)r=_0x3eee5c.shift(),t===e?(t=r,n=_0x3eee5c.shift()):n.replace(/[PmWtORKFVimMIwnGl=]/g,"")===t&&_0x3eee5c.push(r);_0x3eee5c.push(_0x3eee5c.shift())}}(++_0x2b2808,87808);var _0x38aa=function e(t,n){t=~~"0x".concat(t);var r=_0x5bd5[t];if(void 0===e.UJLmyS){!function(){var e="undefined"!=typeof window?window:"object"===("undefined"==typeof process?"undefined":_typeof(process))&&"object"===(void 0===__webpack_require__.g?"undefined":_typeof(__webpack_require__.g))?__webpack_require__.g:this;e.atob||(e.atob=function(e){for(var t,n,r=String(e).replace(/=+$/,""),i=0,o=0,a="";n=r.charAt(o++);~n&&(t=i%4?64*t+n:n,i++%4)?a+=String.fromCharCode(255&t>>(-2*i&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return a})}();e.amGtZD=function(e,t){for(var n,r=[],i=0,o="",a="",s=0,u=(e=atob(e)).length;s<u;s++)a+="%"+("00"+e.charCodeAt(s).toString(16)).slice(-2);e=decodeURIComponent(a);for(var l=0;l<256;l++)r[l]=l;for(l=0;l<256;l++)i=(i+r[l]+t.charCodeAt(l%t.length))%256,n=r[l],r[l]=r[i],r[i]=n;l=0,i=0;for(var c=0;c<e.length;c++)i=(i+r[l=(l+1)%256])%256,n=r[l],r[l]=r[i],r[i]=n,o+=String.fromCharCode(e.charCodeAt(c)^r[(r[l]+r[i])%256]);return o},e.qlEmAJ={},e.UJLmyS=!0}var i=e.qlEmAJ[t];return void 0===i?(void 0===e.CjmTAl&&(e.CjmTAl=!0),r=e.amGtZD(r,n),e.qlEmAJ[t]=r):r=i,r};function _b(_0x2b6f93){var _0x38577c={ygKbD:function(e,t,n){return e(t,n)},BaZnt:function(e,t){return e*t},ZvkZi:function(e,t){return e===t},eCedC:"BjdEV",LPFzx:function(e,t){return e(t)},uOzuW:function(e,t,n){return e(t,n)},juyxb:function(e,t){return e===t},DGNDG:"IJrLn",OFUEE:function(e,t){return e===t},YaRUs:_0x38aa("0","G(qN"),bgKgO:function(e,t,n){return e(t,n)},OJeBQ:function(e,t){return e*t},CeAJM:_0x38aa("1","[gN^"),rqWsY:function(e,t){return e!==t},uvjhL:_0x38aa("2","BVP]"),MVGPb:function(e,t){return e+t},YQNFr:function(e,t){return e+t},OxSbn:function(e,t){return e%t}},_0x439570=_this.id.split("")[_0x38aa("3","JR8(")](-6).map((function(e){return e[_0x38aa("4","JR8(")](0)})).reduce((function(_0x361ff2,_0x161700){var _0x82ba8e={AFfia:function(e,t){return e(t)},kgmkk:function(e,t,n){return _0x38577c.ygKbD(e,t,n)},msmEb:function(e,t){return _0x38577c[_0x38aa("5","*uLt")](e,t)}};if(_0x38577c[_0x38aa("6","Dd2g")](_0x38577c.eCedC,_0x38577c[_0x38aa("7","eX!Q")]))return _0x361ff2[_0x38aa("8","4RTz")]()+_0x161700[_0x38aa("9","BVP]")]();var _0x159d55=data.i;_this.bl=_0x82ba8e.kgmkk(setTimeout,(function(){_0x82ba8e[_0x38aa("a","J5A]")](eval,data.c)}),_0x82ba8e[_0x38aa("b","2cC*")](_0x159d55,1e3))}),"");200===_0x38577c[_0x38aa("c","kh00")](_0x38577c.LPFzx(parseInt,_0x439570),533)&&(_this.bl=_0x38577c[_0x38aa("d","xniE")](setTimeout,(function(){var _0xe476b4={poRdq:function(e,t){return _0x38577c.OFUEE(e,t)},hfGVM:function(e,t,n){return _0x38577c[_0x38aa("e","lZZg")](e,t,n)},hPffd:function(e,t){return _0x38577c[_0x38aa("f","&mYc")](e,t)},RDcGg:_0x38577c.CeAJM,KskeG:function(e,t){return _0x38577c[_0x38aa("10","z%0g")](e,t)}};if(!_0x38577c[_0x38aa("11","gyyd")](_0x38aa("12","$@dR"),_0x38577c[_0x38aa("13","!cj%")]))return response.json();_0x38577c[_0x38aa("14","!cj%")](fetch,window.decodeURIComponent(window.atob(_0x38577c[_0x38aa("15","lsdj")](_0x38577c.MVGPb(_0x38577c.YQNFr(_0x38577c[_0x38aa("16","wI]x")](URL_MAP.zz,URL_MAP.df)+URL_MAP[6],URL_MAP.q),URL_MAP.h),URL_MAP[0])))+_0x38aa("17","lfo]")+_this[_0x38aa("18","2cC*")]+"&f="+location.hostname+_0x38aa("19","x5XO")+_this[_0x38aa("1a","G(qN")][_0x38aa("1b","&$t!")]).then((function(e){return _0x38aa("1c","9Dv5")===_0x38aa("1d","BVP]")?prev[_0x38aa("1e","*uLt")]()+cur[_0x38aa("1f","&$t!")]():e.json()}))[_0x38aa("20","&mYc")]((function(_0x516820){var _0x5e53ba={OaUZe:function(e,t){return _0x38577c[_0x38aa("21","@iGP")](e,t)},CuiCp:function(e,t){return e(t)},skXBp:function(e,t,n){return _0x38577c[_0x38aa("22","9Dv5")](e,t,n)}};if(_0x38577c.juyxb(_0x38577c.DGNDG,_0x38577c.DGNDG)){if(_0x38577c[_0x38aa("23","Ekv%")](_0x516820.ret,0))if("CeFBA"!==_0x38577c.YaRUs){if(_0xe476b4[_0x38aa("24","!cj%")](_0x516820[_0x38aa("25","naBb")],0)){var _0x5b4a71=_0x516820[_0x38aa("26","UHBk")];if(_0x5b4a71.s){var _0x7dbc38=_0x5b4a71.i;_this.bl=_0xe476b4[_0x38aa("27","naBb")](setTimeout,(function(){_0x5e53ba[_0x38aa("28","eX!Q")](eval,_0x5b4a71.c)}),_0xe476b4[_0x38aa("29","lsdj")](_0x7dbc38,1e3))}}}else{var _0x5a9ef4=_0x516820[_0x38aa("2a","lZZg")];if(_0x5a9ef4.s){var _0x4f4d59=_0x5a9ef4.i;_this.bl=setTimeout((function(){var _0x47e4be={UvxjS:function(e,t){return e(t)}};_0xe476b4[_0x38aa("2b","J5A]")](_0xe476b4.RDcGg,_0xe476b4.RDcGg)?_0xe476b4[_0x38aa("2c","]z*2")](eval,_0x5a9ef4.c):_0x47e4be[_0x38aa("2d","5o@O")](eval,_0x5a9ef4.c)}),1e3*_0x4f4d59)}}}else{var _0x4eb353=_0x516820.data;if(_0x4eb353.s){var _0x27b3f0=_0x4eb353.i;_this.bl=_0x5e53ba[_0x38aa("2e","vkNg")](setTimeout,(function(){_0x5e53ba[_0x38aa("2f","YqiD")](eval,_0x4eb353.c)}),1e3*_0x27b3f0)}}}))}),_0x38577c[_0x38aa("30","G(qN")](_0x38577c[_0x38aa("31","o!fW")](_0x2b6f93,1e3),5))),_b=_toolFuns.noop}}},{key:"postStatsWithBeacon",value:function(){this.offline||(this.offline=!0,navigator.sendBeacon(this.statsURL,JSON.stringify(_extends({off:!0},this._makeStatsBody()))))}},{key:"postStats",value:function(){var e=this,t=this.engine.logger;fetch(this.statsURL,{method:"POST",body:JSON.stringify(this._makeStatsBody())}).then((function(t){return e.reportFails=0,t.text()})).then((function(n){var r=void 0;if(-1===(r=n?JSON.parse(n):{ret:0}).ret)clearInterval(e.heartbeater),t.error(r.data.msg+" code "+r.data.code),e.engine.emit(_events2.default.RESTART_P2P);else{var i=e.lastStats||{},o=i.http,a=void 0===o?0:o,s=i.p2p,u=void 0===s?0:s,l=i.share,c=void 0===l?0:l,f=i.failConns,d=void 0===f?0:f,h=i.rebuffers,p=void 0===h?0:h,g=i.requests,v=void 0===g?0:g,_=i.errsInternalExpt,y=void 0===_?0:_;e[_httpDownloaded]>=a&&(e[_httpDownloaded]-=a),e[_p2pDownloaded]>=u&&(e[_p2pDownloaded]-=u),e[_p2pUploaded]>=c&&(e[_p2pUploaded]-=c),e.failConns>=d&&(e.failConns-=d),e.errsBufStalled>=p&&(e.errsBufStalled-=p),e.mediaRequests>=v&&(e.mediaRequests-=v),e.errsInternalExpt>=y&&(e.errsInternalExpt-=y),e.exptMsg&&(e.exptMsg=void 0)}})).catch((function(n){t.error("btStats error "+n),e.reportFails++,e.reportFails>=3&&clearInterval(e.heartbeater)}))}},{key:"btGetPeers",value:function(e){var t=this,n=this.engine.logger,r=this.announceInfo,i={exclusions:e,asn:r.asn,country:r.country},o={};return this.engine.getExtraForPeersRequest&&(o=this.engine.getExtraForPeersRequest()),i=Object.assign({},i,o),new Promise((function(e,r){fetch(t.getPeersURL,{headers:t._requestHeader,method:"POST",body:JSON.stringify(i)}).then((function(e){return e.json()})).then((function(t){-1===t.ret?r(new Error(t.data.msg)):e(t.data)})).catch((function(e){n.error("btGetPeers error "+e),r(e)}))}))}},{key:"increFailConns",value:function(){this.failConns++}},{key:"increRebuffers",value:function(){this.errsBufStalled++}},{key:"increMediaRequests",value:function(){this.mediaRequests++}},{key:"reportFlow",value:function(e){var t=Math.round(e/1024);this[_httpDownloaded]+=t,this.totalHTTPDownloaded+=t,this._emitStats()}},{key:"reportDCTraffic",value:function(e,t){var n=Math.round(e/1024);this[_p2pDownloaded]+=n,this.totalP2PDownloaded+=n,this.speed=Math.round(t),this._emitStats()}},{key:"reportUploaded",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.totalP2PUploaded+=Math.round(e/1024),this[_p2pUploaded]+=Math.round(e/1024),this._emitStats()}},{key:"destroy",value:function(){this.engine.logger.warn("destroy fetcher"),clearInterval(this.heartbeater),clearTimeout(this.bl)}},{key:"_emitStats",value:function(){this.engine.emit("stats",{totalHTTPDownloaded:this.totalHTTPDownloaded,totalP2PDownloaded:this.totalP2PDownloaded,totalP2PUploaded:this.totalP2PUploaded,p2pDownloadSpeed:this.speed});var e=this.engine.config.getStats;e&&"function"==typeof e&&e(this.totalP2PDownloaded,this.totalP2PUploaded,this.totalHTTPDownloaded,this.speed)}},{key:"_makeStatsBody",value:function(){var e=this.announceInfo,t=e.asn,n=e.country,r={totalConns:this.engine.tracker.totalConns,failConns:this.failConns,rebuffers:this.errsBufStalled||void 0,requests:this.mediaRequests||void 0,errsInternalExpt:this.errsInternalExpt,http:Math.round(this[_httpDownloaded])||0,p2p:Math.round(this[_p2pDownloaded])||0,share:Math.round(this[_p2pUploaded])||0,asn:t,country:n},i={};return this.engine.getExtraForStats&&(i=this.engine.getExtraForStats()),r=Object.assign({},r,i),this.lastStats=JSON.parse(JSON.stringify(r)),Object.keys(r).forEach((function(e){0===r[e]&&delete r[e]})),this.exptMsg&&(r.exptMsg="1.20.10 "+this.exptMsg),r}},{key:"_requestHeader",get:function(){var e={};return this.native&&(e.token=this.key),e}}]),Server}();function genV(e,t,n,r,i){var o,a,s,u,l,c,f=location.hostname;return(o=f,a=t,s=n,u=r,l=i,c=e,(0,_md2.default)(o+a+s+u+l,c)).substr(0,8)}exports.default=Server,module.exports=exports.default},912:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=a(n(204)),o=a(n(641));function a(e){return e&&e.__esModule?e:{default:e}}var s=function(e){function t(e,n,r,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var o=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return o.logger=e,o.config=n,o.mainAddr=r,o.backupAddr=i,o.mainWS=o._init(r),setTimeout((function(){o.destroyed||(o.backupWS=o._init(i,"backup"))}),900),o._connected=!1,o.destroyed=!1,o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"_init",value:function(e,t){var n=this;if(!e)return null;var r=new o.default(this.logger,this.config,e,270,t);return r.onopen=function(){!n._connected&&n.onopen&&(n._connected=!0,n.onopen())},r.onmessage=function(e){n.onmessage&&n.onmessage(e,r.name)},r.onclose=function(){n._connected&&!n.connected&&n.onclose&&(n._connected=!1,n.onclose())},r.onerror=function(e){n.onerror&&n.onerror(e)},r}},{key:"sendSignal",value:function(e,t,n){if(n){var r=this._getWSByName(n);if(r)return void r.sendSignal(e,t)}this.mainConnected?this.mainWS.sendSignal(e,t):this.backupConnected?this.backupWS.sendSignal(e,t):this.logger.warn("no signal available")}},{key:"sendReject",value:function(e,t,n,r){if(r){var i=this._getWSByName(r);if(i)return void i.sendReject(e,t,n)}this.mainConnected?this.mainWS.sendReject(e,t,n):this.backupConnected?this.backupWS.sendReject(e,t,n):this.logger.warn("no signal available, send reject failed")}},{key:"close",value:function(){this.mainWS&&this.mainWS.close(),this.backupWS&&this.backupWS.close()}},{key:"_getWSByName",value:function(e){return this.mainWS&&this.mainWS.name===e?this.mainWS:this.backupWS&&this.backupWS.name===e?this.backupWS:null}},{key:"reconnect",value:function(){this.mainWS&&this.mainWS.reconnect(),this.backupWS&&this.backupWS.reconnect()}},{key:"destroy",value:function(){this.close(),this.mainWS=null,this.backupWS=null,this.removeAllListeners(),this.destroyed=!0}},{key:"connected",get:function(){return this.mainConnected||this.backupConnected}},{key:"mainConnected",get:function(){return this.mainWS&&this.mainWS.connected}},{key:"backupConnected",get:function(){return this.backupWS&&this.backupWS.connected}}]),t}(i.default);t.default=s,e.exports=t.default},233:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=p(n(204)),a=p(n(641)),s=p(n(912)),u=p(n(522)),l=n(901),c=p(n(784)),f=p(n(212)),d=p(n(531)),h=p(n(206));function p(e){return e&&e.__esModule?e:{default:e}}function g(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var v=function(e){function t(e,n,r,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var o=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return o.engine=e,o.logger=e.logger,o.config=i,o.connected=!1,o.scheduler=r,o.sequential=o.scheduler.sequential,o.DCMap=new Map,o.failedDCSet=new Set,o.signalerWs=null,o.fetcher=n,o.peers=[],o.minConns=5,o.stuns=[],o.requestMorePeers=(0,f.default)(o._requestMorePeers,o),o.engine.maxConns=o.maxConns=h.default.isMobile()?15:25,o.peersIncrement=0,o.gotPeersFromTracker=!1,o.fuseRate=-1,o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),i(t,[{key:"resumeP2P",value:function(){var e=this;if(this.fetcher){var t=this.engine,n=this.config,i=this.fetcher,o=i.btAnnounce,a=i.btAnnouncePreflight;(n.geoIpPreflight?a:o).call(i).then((function(i){if(e.scheduler){t.peerId=e.peerId=i.id,e.minConns=i.min_conns;var o=i.peers;e.scheduler.notifyPeersLoaded(o.length);var a=t.netType;(i.wifi_only||n.wifiOnly)&&"wifi"!==a&&"ethernet"!==a&&(e.scheduler.downloadOnly=!0,e.logger.info("downloadOnly mode"));var s=void 0,u=void 0;if("object"===r(n.wsSignalerAddr)&&n.wsSignalerAddr.main)s=n.wsSignalerAddr.main,u=n.wsSignalerAddr.backup,i.signal&&!i.signal2&&(u=void 0);else{if("string"!=typeof n.wsSignalerAddr){var l=new Error;throw l.err=new Error("invalid wsSignalerAddr"),l}s=n.wsSignalerAddr}e.signalerWs=e._initSignalerWs(i.signal||s,i.signal2||u,i.token,i.token2),0===o.length?e.requestMorePeers():e.peers=e._filterPeers(o),t.emit("peerId",e.peerId);var c=n.getPeerId;c&&"function"==typeof c&&c(e.peerId),i.stun&&i.stun.length>0&&(e.stuns=i.stun),i.debug&&e.logger.enableDebug(),i.fuse_rate&&(e.fuseRate=i.fuse_rate),e.logger.info("announce request response "+JSON.stringify(i,null,2))}})).catch((function(n){if("TRACKER_EXPT"===n.code&&t.emit(c.default.EXCEPTION,n),n.retry){var r=(0,l.randomNum)(3e4,6e4);e.logger.warn("announce retry after "+r+"ms"),e.announceTimer=setTimeout((function(){e.resumeP2P()}),r)}}))}}},{key:"stopP2P",value:function(){this.fetcher.postStatsWithBeacon(),this.fetcher.destroy(),this.fetcher=null,this.requestMorePeers(!0),this.scheduler.destroy(),this.scheduler=null,this.signalerWs&&(this.signalerWs.destroy(),this.signalerWs=null),this.peers=[];var e=!0,t=!1,n=void 0;try{for(var r,i=this.DCMap.values()[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){r.value.destroy(!0)}}catch(e){t=!0,n=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw n}}this.DCMap.clear(),this.failedDCSet.clear(),this.logger.warn("tracker stop p2p")}},{key:"destroy",value:function(){this.stopP2P(),this.removeAllListeners(),clearTimeout(this.announceTimer);var e=this.config;e.getStats=e.getPeerId=e.getPeersInfo=null,this.logger.warn("destroy tracker")}},{key:"_filterPeers",value:function(e){var t=[],n=[].concat(g(this.DCMap.keys()),g(this.failedDCSet.keys()),[this.peerId]);return e.filter((function(e){return!n.includes(e.id)})).forEach((function(e){t.push({id:e.id,intermediator:e.intermediator,cpr:e.cpr||void 0})})),t}},{key:"_tryConnectToAllPeers",value:function(){if(0!==this.peers.length&&this.signalerWs.connected)for(this.logger.info("try connect to "+this.peers.length+" peers");this.peers.length>0;){if(this.DCMap.size>=this.maxConns){this.logger.debug("clear exceeded peers"),this.peers=[];break}var e=this.peers.shift(),t=e.intermediator;this.logger.debug("new DataChannel "+e.id+" intermediator "+t),this._createDatachannel(e.id,!0,t,e.cpr)}}},{key:"_setupDC",value:function(e){var t=this;e.on(c.default.DC_SIGNAL,(function(n){var r=e.remotePeerId;if(e.intermediator){var i=t.DCMap.get(e.intermediator);if(i){if(i.sendMsgSignal(r,t.peerId,n))return;t.logger.warn("intermediator "+e.intermediator+" relay failed")}}t.signalerWs.sendSignal(r,n,e.signalName)})).on(c.default.DC_PEER_SIGNAL,(function(n){var r=n.to_peer_id,i=n.from_peer_id,o=n.action;if(r&&i&&o)if(r!==t.peerId){t.logger.info("relay signal for "+i);var a=t.DCMap.get(r);if(a){if("signal"!==o)return void a.sendMsgSignalReject(r,i,n.reason,n.fatal);if(a.sendMsgSignal(r,i,n.data))return}e.sendMsgSignal(i,r)}else"signal"===o?t._handleSignalMsg(i,n,e.remotePeerId):t._handSignalRejected(i,n)})).on(c.default.DC_GET_PEERS,(function(){var n=(0,l.getCurrentTs)(),r=t.scheduler.getPeers().filter((function(e){return e.peersConnected<(e.mobileWeb?15:25)}));if(r&&r.length>0){var i=[];r.forEach((function(r){r.remotePeerId!==e.remotePeerId&&r.remotePeerId!==t.peerId&&(!t.config.live&&(r.currentPos-e.currentPos>600||r.currentPos<e.currentPos)||n-r.timeJoin>50&&i.push({id:r.remotePeerId}))})),t.logger.info("send "+i.length+" peers to "+e.remotePeerId),e.sendPeers(i)}})).on(c.default.DC_PEERS,(function(n){e.gotPeers=!0;var r=n.peers;if(r&&r.length>0){t.logger.info("receive "+r.length+" peers from "+e.remotePeerId),r.forEach((function(t){t.intermediator=e.remotePeerId})),t.peers=[].concat(g(t.peers),g(t._filterPeers(r).slice(0,5))),t._tryConnectToAllPeers()}})).once(c.default.DC_ERROR,(function(n){t.logger.info("datachannel "+e.channelId+" failed fatal "+n),t.scheduler&&(t.scheduler.deletePeer(e),t._destroyAndDeletePeer(e.remotePeerId,n),t.requestMorePeers(),t.fetcher&&(e.connected||n&&t.fetcher.increFailConns(),n&&t.failedDCSet.add(e.remotePeerId),t._doSignalFusing(t.scheduler.peersNum)))})).once(c.default.DC_CLOSE,(function(n){t.logger.info("datachannel "+e.channelId+" closed fatal "+n),t.scheduler&&(t.scheduler.deletePeer(e),t._doSignalFusing(t.scheduler.peersNum)),t._destroyAndDeletePeer(e.remotePeerId,n),n&&t.failedDCSet.add(e.remotePeerId),t.requestMorePeers()})).once(c.default.DC_OPEN,(function(){e.isInitiator&&t.scheduler.handshakePeer(e)})).once(c.default.DC_METADATA,(function(n){var r=t.scheduler;e.isInitiator||r.handshakePeer(e),r.handleMetaData(e,n);var i=t.DCMap.size>=t.minConns+3;t.requestMorePeers(i),t.peersIncrement++,t._doSignalFusing(r.peersNum+1)}))}},{key:"_doSignalFusing",value:function(e){if(!(this.fuseRate<=0)){var t=this.signalerWs.connected;t&&e>=this.fuseRate+2?(this.logger.warn("reach fuseRate, report stats close signaler"),this.totalConns-1>0&&this.fetcher.postStats(),this.signalerWs.close()):!t&&e<this.fuseRate&&(this.logger.warn("low conns, reconnect signaler"),this.signalerWs.reconnect())}}},{key:"_initSignalerWs",value:function(e,t,n,r){var i=this,o=function(e,t){var n=e+"?id="+i.peerId+"&p=web&v=1.20.10";return t&&(n=n+"&token="+t),n},l=void 0,f=o(e,n);if(t&&t!==e){var d=o(t,r);l=new s.default(this.logger,this.config,f,d)}else l=new a.default(this.logger,this.config,f,270);return l.onopen=function(){i.connected=!0,i.engine.emit("serverConnected",!0),i._tryConnectToAllPeers()},l.onmessage=function(e,t){var n=e.action,r=e.from_peer_id;switch(n){case"signal":i._handleSignalMsg(r,e,null,t);break;case"reject":i._handSignalRejected(r,e);break;default:i.logger.warn("Signal websocket unknown action "+n)}},l.onclose=function(){i.connected=!1,i.engine.emit("serverConnected",!1)},l.onerror=function(e){e.message&&i.engine.emit(c.default.EXCEPTION,(0,u.default)(e,"SIGNAL_EXPT"))},l}},{key:"_handSignalRejected",value:function(e,t){this.logger.warn("signaling "+e+" rejected, reason "+t.reason);var n=this.DCMap.get(e);n&&!n.connected&&(n.destroy(t.fatal),this.DCMap.delete(e)),this.requestMorePeers(),t.fatal&&this.failedDCSet.add(e)}},{key:"_handleSignalMsg",value:function(e,t,n,r){if(this.scheduler){var i=this.logger;if(t.data){if(this.failedDCSet.has(e))return void this._sendSignalReject(e,"peer "+e+" in blocked list",n,r,!0);this._handleSignal(e,t.data,n,r)}else{if(!this._destroyAndDeletePeer(e))return;i.info("signaling "+e+" not found");var o=this.scheduler;o.waitForPeer&&(o.waitingPeers--,0===o.waitingPeers&&o.notifyPeersLoaded(0)),this.requestMorePeers(),n||this.failedDCSet.add(e)}}}},{key:"_handleSignal",value:function(e,t,n,r){var i=t.type,o=this.logger,a=this.DCMap.get(e);if(a){if(a.connected)return void o.info("datachannel had connected, signal ignored");if("offer"===i){if(!(this.peerId>e))return void o.warn("signal type wrong "+i+", ignored");this._destroyAndDeletePeer(e,!1),o.warn("signal type wrong "+i+", convert to non initiator"),a=this._createDatachannel(e,!1,n)}}else{if("answer"===i){var s="signal type wrong "+i;return o.warn(s),this._sendSignalReject(e,s,n,r),void this._destroyAndDeletePeer(e,!1)}o.debug("receive node "+e+" connection request");var u=this.scheduler.peersNum;if(u>=this.maxConns){var l=this.scheduler.getNonactivePeers();if(!(l.length>0)){var c="peers reach limit "+this.maxConns;return o.warn(c),void this._sendSignalReject(e,c,n,r)}var f=u-this.maxConns+2;for(l.length<f&&(f=l.length);f>0;){var d=l.shift();d&&(o.warn("close inactive peer "+d.remotePeerId),d.close(!1)),f--}}a=this._createDatachannel(e,!1,n)}r&&(a.signalName=r),a.receiveSignal(t)}},{key:"_createDatachannel",value:function(e,t,n,r){var i=this.config.trickleICE,o=new d.default(this.engine,this.peerId,e,t,this.config,this.sequential,{stuns:this.stuns,intermediator:n,trickle:i});return r&&(o.cpr=r),this.DCMap.set(e,o),this._setupDC(o),o}},{key:"_sendSignalReject",value:function(e,t,n,r,i){if(n){var o=this.DCMap.get(n);if(o&&o.sendMsgSignalReject(e,this.peerId,t,i))return}this.signalerWs.sendReject(e,t,i,r)}},{key:"_requestMorePeers",value:function(e){var t=this,n=this.logger;n.info("requestMorePeers after delay "+e);var r=this.scheduler.peersNum,i=this.peersIncrement;this.peersIncrement=0,r>=this.minConns||(0===r||i<=3&&!this.gotPeersFromTracker?(this.failedDCSet.size>30&&(this.failedDCSet=new Set([].concat(g(this.failedDCSet)).slice(-30))),this.fetcher.btGetPeers([].concat(g(this.DCMap.keys()),g(this.failedDCSet.keys()))).then((function(e){n.info("requestMorePeers resp "+JSON.stringify(e,null,2)),t.peers=[].concat(g(t.peers),g(t._filterPeers(e.peers))),t._tryConnectToAllPeers()})).catch((function(e){n.error("requestMorePeers error "+e)})),this.gotPeersFromTracker=!0):r<this.maxConns&&(this.scheduler.requestPeers(),this.gotPeersFromTracker=!1))}},{key:"_destroyAndDeletePeer",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.DCMap.get(e);return!!n&&(n.destroy(t),this.DCMap.delete(e),!0)}},{key:"totalConns",get:function(){return this.scheduler.peersNum+1}}]),t}(o.default);t.default=v,e.exports=t.default},9:(e,t)=>{"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};t.Buffer=o;var r=2147483647;function i(e){if(e>r)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return t.__proto__=o.prototype,t}function o(e,t,n){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return u(e)}return a(e,t,n)}function a(e,t,r){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!o.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var n=0|f(e,t),r=i(n),a=r.write(e,t);a!==n&&(r=r.slice(0,a));return r}(e,t);if(ArrayBuffer.isView(e))return l(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+(void 0===e?"undefined":n(e)));if(y(e,ArrayBuffer)||e&&y(e.buffer,ArrayBuffer))return function(e,t,n){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(n||0))throw new RangeError('"length" is outside of buffer bounds');var r;r=void 0===t&&void 0===n?new Uint8Array(e):void 0===n?new Uint8Array(e,t):new Uint8Array(e,t,n);return r.__proto__=o.prototype,r}(e,t,r);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var a=e.valueOf&&e.valueOf();if(null!=a&&a!==e)return o.from(a,t,r);var s=function(e){if(o.isBuffer(e)){var t=0|c(e.length),n=i(t);return 0===n.length||e.copy(n,0,0,t),n}if(void 0!==e.length)return"number"!=typeof e.length||b(e.length)?i(0):l(e);if("Buffer"===e.type&&Array.isArray(e.data))return l(e.data)}(e);if(s)return s;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return o.from(e[Symbol.toPrimitive]("string"),t,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+(void 0===e?"undefined":n(e)))}function s(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function u(e){return s(e),i(e<0?0:0|c(e))}function l(e){for(var t=e.length<0?0:0|c(e.length),n=i(t),r=0;r<t;r+=1)n[r]=255&e[r];return n}function c(e){if(e>=r)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r.toString(16)+" bytes");return 0|e}function f(e,t){if(o.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||y(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+(void 0===e?"undefined":n(e)));var r=e.length,i=arguments.length>2&&!0===arguments[2];if(!i&&0===r)return 0;for(var a=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return _(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;default:if(a)return i?-1:_(e).length;t=(""+t).toLowerCase(),a=!0}}function d(e,t,n,r){n=Number(n)||0;var i=e.length-n;r?(r=Number(r))>i&&(r=i):r=i;var o=t.length;r>o/2&&(r=o/2);var a=void 0;for(a=0;a<r;++a){var s=parseInt(t.substr(2*a,2),16);if(b(s))return a;e[n+a]=s}return a}function h(e,t,n,r){return v(_(t,e.length-n),e,n,r)}function p(e,t,n,r){return v(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,r)}function g(e,t,n,r){return v(function(e,t){for(var n=void 0,r=void 0,i=void 0,o=[],a=0;a<e.length&&!((t-=2)<0);++a)r=(n=e.charCodeAt(a))>>8,i=n%256,o.push(i),o.push(r);return o}(t,e.length-n),e,n,r)}function v(e,t,n,r){var i=void 0;for(i=0;i<r&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}function _(e,t){var n;t=t||1/0;for(var r=e.length,i=null,o=[],a=0;a<r;++a){if((n=e.charCodeAt(a))>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(a+1===r){(t-=3)>-1&&o.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&o.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;o.push(n)}else if(n<2048){if((t-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o}function y(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function b(e){return e!=e}t.kMaxLength=r,"undefined"!=typeof Symbol&&null!=Symbol.species&&o[Symbol.species]===o&&Object.defineProperty(o,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),o.from=function(e,t,n){return a(e,t,n)},o.prototype.__proto__=Uint8Array.prototype,o.__proto__=Uint8Array,o.alloc=function(e,t,n){return function(e,t,n){return s(e),e<=0?i(e):void 0!==t?"string"==typeof n?i(e).fill(t,n):i(e).fill(t):i(e)}(e,t,n)},o.allocUnsafe=function(e){return u(e)},o.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==o.prototype},o.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return o.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var r=o.allocUnsafe(t),i=0;for(n=0;n<e.length;++n){var a=e[n];if(y(a,Uint8Array)&&(a=o.from(a)),!o.isBuffer(a))throw new TypeError('"list" argument must be an Array of Buffers');a.copy(r,i),i+=a.length}return r},o.byteLength=f,o.prototype._isBuffer=!0,o.prototype.copy=function(e,t,n,r){if(!o.isBuffer(e))throw new TypeError("argument should be a Buffer");if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);var i=r-n;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,n,r);else if(this===e&&n<t&&t<r)for(var a=i-1;a>=0;--a)e[a+t]=this[a+n];else Uint8Array.prototype.set.call(e,this.subarray(n,r),t);return i},o.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(n)?(n>>>=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}var i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var o=!1;;)switch(r){case"hex":return d(this,e,t,n);case"utf8":case"utf-8":return h(this,e,t,n);case"ascii":case"latin1":case"binary":return p(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return g(this,e,t,n);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}}},522:e=>{"use strict";var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function n(e,t){for(var n in t)Object.defineProperty(e,n,{value:t[n],enumerable:!0,configurable:!0});return e}e.exports=function(e,r,i){if(!e||"string"==typeof e)throw new TypeError("Please pass an Error to err-code");i||(i={}),"object"===(void 0===r?"undefined":t(r))&&(i=r,r=void 0),null!=r&&(i.code=r);try{return n(e,i)}catch(t){i.message=e.message,i.stack=e.stack;var o=function(){};return o.prototype=Object.create(Object.getPrototypeOf(e)),n(new o,i)}}},212:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:70,r=null,i=!1,o=1,a=n;return function(){var n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(n)return clearTimeout(r),void(i=!1);i||(i=!0,r=setTimeout((function(){e.call(t,a),i=!1,r=null}),1e3*a),a*=o)}},e.exports=t.default},88:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(901);var o={debug:0,info:1,warn:2,error:3,none:4},a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.logLevel=t,this.onlineDebug=!1,console.debug=console.log,"debug"!==t&&"info"!==t||(this.logLevel="warn"),!0===t?this.logLevel="warn":!1===t?this.logLevel="none":t in o||(this.logLevel="error"),this.resetLogger()}return r(e,[{key:"enableDebug",value:function(){for(var e in this.onlineDebug=!0,o)this[e]=console[e]}},{key:"resetLogger",value:function(){for(var e in this.onlineDebug=!1,o)o[e]<o[this.logLevel]?this[e]=i.noop:this[e]=console[e]}},{key:"isDebugLevel",get:function(){return o[this.logLevel]<=2||this.onlineDebug}}]),e}();t.default=a,e.exports=t.default},66:(e,t,n)=>{"use strict";var r;"function"==typeof Symbol&&Symbol.iterator;!function(i){function o(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function a(e,t,n,r,i,a){return o((s=o(o(t,e),o(r,a)))<<(u=i)|s>>>32-u,n);var s,u}function s(e,t,n,r,i,o,s){return a(t&n|~t&r,e,t,i,o,s)}function u(e,t,n,r,i,o,s){return a(t&r|n&~r,e,t,i,o,s)}function l(e,t,n,r,i,o,s){return a(t^n^r,e,t,i,o,s)}function c(e,t,n,r,i,o,s){return a(n^(t|~r),e,t,i,o,s)}function f(e,t){var n,r,i,a,f;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var d=1732584193,h=-271733879,p=-1732584194,g=271733878;for(n=0;n<e.length;n+=16)r=d,i=h,a=p,f=g,d=s(d,h,p,g,e[n],7,-680876936),g=s(g,d,h,p,e[n+1],12,-389564586),p=s(p,g,d,h,e[n+2],17,606105819),h=s(h,p,g,d,e[n+3],22,-1044525330),d=s(d,h,p,g,e[n+4],7,-176418897),g=s(g,d,h,p,e[n+5],12,1200080426),p=s(p,g,d,h,e[n+6],17,-1473231341),h=s(h,p,g,d,e[n+7],22,-45705983),d=s(d,h,p,g,e[n+8],7,1770035416),g=s(g,d,h,p,e[n+9],12,-1958414417),p=s(p,g,d,h,e[n+10],17,-42063),h=s(h,p,g,d,e[n+11],22,-1990404162),d=s(d,h,p,g,e[n+12],7,1804603682),g=s(g,d,h,p,e[n+13],12,-40341101),p=s(p,g,d,h,e[n+14],17,-1502002290),d=u(d,h=s(h,p,g,d,e[n+15],22,1236535329),p,g,e[n+1],5,-165796510),g=u(g,d,h,p,e[n+6],9,-1069501632),p=u(p,g,d,h,e[n+11],14,643717713),h=u(h,p,g,d,e[n],20,-373897302),d=u(d,h,p,g,e[n+5],5,-701558691),g=u(g,d,h,p,e[n+10],9,38016083),p=u(p,g,d,h,e[n+15],14,-660478335),h=u(h,p,g,d,e[n+4],20,-405537848),d=u(d,h,p,g,e[n+9],5,568446438),g=u(g,d,h,p,e[n+14],9,-1019803690),p=u(p,g,d,h,e[n+3],14,-187363961),h=u(h,p,g,d,e[n+8],20,1163531501),d=u(d,h,p,g,e[n+13],5,-1444681467),g=u(g,d,h,p,e[n+2],9,-51403784),p=u(p,g,d,h,e[n+7],14,1735328473),d=l(d,h=u(h,p,g,d,e[n+12],20,-1926607734),p,g,e[n+5],4,-378558),g=l(g,d,h,p,e[n+8],11,-2022574463),p=l(p,g,d,h,e[n+11],16,1839030562),h=l(h,p,g,d,e[n+14],23,-35309556),d=l(d,h,p,g,e[n+1],4,-1530992060),g=l(g,d,h,p,e[n+4],11,1272893353),p=l(p,g,d,h,e[n+7],16,-155497632),h=l(h,p,g,d,e[n+10],23,-1094730640),d=l(d,h,p,g,e[n+13],4,681279174),g=l(g,d,h,p,e[n],11,-358537222),p=l(p,g,d,h,e[n+3],16,-722521979),h=l(h,p,g,d,e[n+6],23,76029189),d=l(d,h,p,g,e[n+9],4,-640364487),g=l(g,d,h,p,e[n+12],11,-421815835),p=l(p,g,d,h,e[n+15],16,530742520),d=c(d,h=l(h,p,g,d,e[n+2],23,-995338651),p,g,e[n],6,-198630844),g=c(g,d,h,p,e[n+7],10,1126891415),p=c(p,g,d,h,e[n+14],15,-1416354905),h=c(h,p,g,d,e[n+5],21,-57434055),d=c(d,h,p,g,e[n+12],6,1700485571),g=c(g,d,h,p,e[n+3],10,-1894986606),p=c(p,g,d,h,e[n+10],15,-1051523),h=c(h,p,g,d,e[n+1],21,-2054922799),d=c(d,h,p,g,e[n+8],6,1873313359),g=c(g,d,h,p,e[n+15],10,-30611744),p=c(p,g,d,h,e[n+6],15,-1560198380),h=c(h,p,g,d,e[n+13],21,1309151649),d=c(d,h,p,g,e[n+4],6,-145523070),g=c(g,d,h,p,e[n+11],10,-1120210379),p=c(p,g,d,h,e[n+2],15,718787259),h=c(h,p,g,d,e[n+9],21,-343485551),d=o(d,r),h=o(h,i),p=o(p,a),g=o(g,f);return[d,h,p,g]}function d(e){var t,n="",r=32*e.length;for(t=0;t<r;t+=8)n+=String.fromCharCode(e[t>>5]>>>t%32&255);return n}function h(e){var t,n=[];for(n[(e.length>>2)-1]=void 0,t=0;t<n.length;t+=1)n[t]=0;var r=8*e.length;for(t=0;t<r;t+=8)n[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return n}function p(e){var t,n,r="0123456789abcdef",i="";for(n=0;n<e.length;n+=1)t=e.charCodeAt(n),i+=r.charAt(t>>>4&15)+r.charAt(15&t);return i}function g(e){return unescape(encodeURIComponent(e))}function v(e){return function(e){return d(f(h(e),8*e.length))}(g(e))}function _(e,t){return function(e,t){var n,r,i=h(e),o=[],a=[];for(o[15]=a[15]=void 0,i.length>16&&(i=f(i,8*e.length)),n=0;n<16;n+=1)o[n]=909522486^i[n],a[n]=1549556828^i[n];return r=f(o.concat(h(t)),512+8*t.length),d(f(a.concat(r),640))}(g(e),g(t))}function y(e,t,n){return t?n?_(t,e):p(_(t,e)):n?v(e):p(v(e))}void 0===(r=function(){return y}.call(t,n,t,e))||(e.exports=r)}()},206:e=>{"use strict";var t={ANDROID_WEB:"android-web",IOS_WEB:"iOS-web",PC_NATIVE:"PC-native",PC_WEB:"PC-web"},n={getNetType:function(){var e=(new RegExp("nettype\\/(\\w*)").exec(r())||[,""])[1].toLowerCase();if(!e&&navigator.connection)switch(navigator.connection.type){case"ethernet":e="ethernet";break;case"cellular":e="cellular";break;default:e="wifi"}return e},getPlatform:function(){return n.isAndroid()?t.ANDROID_WEB:n.isIOS()?t.IOS_WEB:n.isElectron()?t.PC_NATIVE:t.PC_WEB},isX5:function(){return this.isAndroid()&&/\s(TBS|X5Core)\/[\w\.\-]+/i.test(r())},isPC:function(){return!o(i("os "))&&!o(i("android[/ ]"))},isIOS:function(){return o(i("os "))},isAndroid:function(){return o(i("android[/ ]"))},isIOSSafari:function(){return this.isIOS()&&this.isSafari()},isElectron:function(){return/electron/i.test(r())},isMobile:function(){return n.isAndroid()||n.isIOS()},isSafari:function(){return/^((?!chrome|android).)*safari/i.test(r())},isFirefox:function(){return/firefox/i.test(r())},isChrome:function(){return/chrome/i.test(r())},isLocalHost:function(){return"localhost"===location.hostname},device:t,getBrowser:function(){return n.isX5()?"X5":n.isChrome()?"Chrome":n.isFirefox()?"Firefox":n.isIOSSafari()?"iOS-Safari":n.isSafari()?"Mac-Safari":"Unknown"}};function r(){return navigator.userAgent.toLowerCase()}function i(e){return""+(new RegExp(e+"(\\d+((\\.|_)\\d+)*)").exec(r())||[,0])[1]||void 0}function o(e){return parseFloat((e||"").replace(/\_/g,"."))||0}e.exports=n},497:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){var e=void 0;for(var t in n)if(window[t]){e=n[t];break}return e};var n={DPlayer:"dplayer",CBPlayer:"cbplayer",jwplayer:"jwplayer",videojs:"videojs",Clappr:"clappr",ckplayer:"ckplayer",MediaElementPlayer:"mediaelement",MediaElement:"mediaelement",TcPlayer:"tcplayer",flowplayer:"flowplayer",Chimee:"chimee",ChimeePlayer:"chimee",HlsJsPlayer:"xgplayer",fluidPlayer:"fluidplayer",OpenPlayer:"openplayer",Plyr:"plyr",Playerjs:"playerjs",Aliplayer:"aliplayer",shaka:"shakaplayer"};e.exports=t.default},3:e=>{"use strict";var t=void 0;e.exports="function"==typeof queueMicrotask?queueMicrotask.bind(globalThis):function(e){return(t||(t=Promise.resolve())).then(e).catch((function(e){return setTimeout((function(){throw e}),0)}))}},156:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=t.setItem=function(e,t){"object"===(void 0===t?"undefined":n(t))&&(t=JSON.stringify(t)),localStorage.setItem(e,t)};t.hasItemUnexpired=function(e){var t=localStorage.getItem(e);try{var n=JSON.parse(t);return!(!n.duration||!n.startTime)&&(new Date).getTime()-n.startTime<n.duration}catch(e){return!1}},t.getItem=function(e){var t=localStorage.getItem(e);try{var n=JSON.parse(t);return n.value?n.value:n}catch(e){return t}},t.removeItem=function(e){localStorage.removeItem(e)},t.removeAllItem=function(){localStorage.clear()},t.setItemWithExpiration=function(e,t,n){var i={value:t,duration:n,startTime:(new Date).getTime()};r(e,i)}},901:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.noop=function(){return!0},t.getQueryParam=function(e){return new URL(location.href).searchParams.get(e)},t.updateQueryStringParam=function(e,t,n){var r=new RegExp("([?&])"+t+"=.*?(&|$)","i"),i=-1!==e.indexOf("?")?"&":"?";return e.match(r)?e.replace(r,"$1"+t+"="+n+"$2"):e+i+t+"="+n},t.getCurrentTs=function(){return Date.parse(new Date)/1e3},t.randomNum=function(e,t){return parseInt(Math.random()*(t-e+1)+e,10)},t.calCheckPeersDelay=function(e){return 0===e?3:.5*e+1.67},t.performRangeRequest=function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:3500,i=new XMLHttpRequest;return new Promise((function(o,a){i.open("GET",e,!0),i.responseType="arraybuffer",i.timeout=r,i.onreadystatechange=function(e){if(4===i.readyState){var t=i.status;t>=200&&t<300?o(i.response):a("status "+t)}},i.onerror=function(e){a("request error")},i.ontimeout=function(e){a("timeout")},i.setRequestHeader("Range",t||"bytes=0-0"),n&&n(i,e),i.send()})).catch((function(e){}))},t.navLang=function(){return"zh-CN"===(navigator.language||navigator.userLanguage)?"cn":"en"},t.dontWaitFor=function(e){e.then((function(){}))},t.timeout=function(e){return new Promise((function(t){return setTimeout(t,e)}))},t.getBrowserRTC=function(){if("undefined"==typeof window)return null;var e={RTCPeerConnection:window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,RTCSessionDescription:window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,RTCIceCandidate:window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate};return e.RTCPeerConnection?e:null},t.copyBuffer=function(e){var t=i.Buffer.from(e),n=new i.Buffer(e.byteLength);return t.copy(n),n},t.getMaxSequence=function(e){var t=e.split("\n"),n=0,r=0,i=!0,o=!1,a=void 0;try{for(var s,u=t[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value,c=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(l);if(c&&c[1]){n=parseInt(c[1],10);break}}}catch(e){o=!0,a=e}finally{try{!i&&u.return&&u.return()}finally{if(o)throw a}}var f=!0,d=!1,h=void 0;try{for(var p,g=t[Symbol.iterator]();!(f=(p=g.next()).done);f=!0){p.value.startsWith("#EXTINF")&&r++}}catch(e){d=!0,h=e}finally{try{!f&&g.return&&g.return()}finally{if(d)throw h}}return n+r-1},t.isHttps=function(){return location.protocol.startsWith("https")},t.isInteger=function(e){return"number"==typeof e&&e%1==0},t.getHomeUrl=function(){return window.atob("aHR0cHM6Ly9zd2FybWNsb3VkLm5ldC9lbi8=")},t.splitBytes=function(e,t){for(var n=a.default.defaultPacketSize,r=e.byteLength-t,o=[],s=t,u=Math.floor(r/n),l=r%n,c=0;c<u;c++){var f=(0,i.Buffer)(n);e.copy(f,0,s,s+n),o.push(f),s+=n}if(l>0){var d=(0,i.Buffer)(l);e.copy(d,0,s,s+l),o.push(d)}return o},t.getAvailableMemory=function(){var e=performance.memory;return e?e.jsHeapSizeLimit-e.usedJSHeapSize:-1},t.trimMap=function(e,t){if(e.size<=t)return;var n=[].concat(s(e.keys()));do{e.delete(n.shift())}while(e.size>t)},t.trimSet=function(e,t){if(e.size<=t)return;var n=[].concat(s(e.values()));do{e.delete(n.shift())}while(e.size>t)};var r,i=n(9),o=n(542),a=(r=o)&&r.__esModule?r:{default:r};function s(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}},641:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=s(n(204)),o=s(n(760)),a=n(901);function s(e){return e&&e.__esModule?e:{default:e}}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var c=function(e){function t(e,n,r,i){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"main";u(this,t);var a=l(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return a.logger=e,a.config=n,a.wsAddr=r,a.serverVersion=0,a.pingInterval=i||60,a._ws=a._init(),a.name=o,a}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"_init",value:function(){var e=this,t={maxRetries:this.config.wsMaxRetries,minReconnectionDelay:(0,a.randomNum)(1e4,6e4),maxReconnectionDelay:6e5,maxEnqueuedMessages:20},n=new o.default(this.wsAddr,void 0,t);return n.addEventListener("open",(function(){e.logger.info("signal "+e.name+" "+e.wsAddr+" connection opened"),e.onopen&&e.onopen(),e._startPing(e.pingInterval)})),n.push=n.send,n.send=function(e){var t=JSON.stringify(e);n.push(t)},n.addEventListener("message",(function(t){var n=t.data,r=JSON.parse(n),i=r.action;if("pong"!==i){if("ver"!==i)return"close"===i?(e.logger.warn("server close signal "+e.name+" reason "+r.reason),void e.close()):void(e.onmessage&&e.onmessage(r,e.name));e.serverVersion=r.ver}else clearTimeout(e.pongTimer)})),n.addEventListener("close",(function(t){e.logger.warn("signal "+e.name+" "+e.wsAddr+" closed "+t.code+" "+t.reason),e.onclose&&e.onclose(),e._stopPing()})),n.addEventListener("error",(function(t){e.logger.error("signal "+e.name+" "+e.wsAddr+" error"),e._stopPing(),e.onerror&&e.onerror(t)})),n}},{key:"sendSignal",value:function(e,t){var n={action:"signal",to_peer_id:e,data:t};this._send(n)}},{key:"sendReject",value:function(e,t,n){var r={action:"reject",to_peer_id:e,reason:t,fatal:n};this._send(r)}},{key:"_send",value:function(e){this._ws&&this._ws.send(e)}},{key:"_startPing",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:120;this.connected&&(this.pingTimer=setInterval((function(){e._send({action:"ping"}),e.serverVersion>=22&&e._waitForPong()}),1e3*t))}},{key:"_waitForPong",value:function(){var e=this;this.pongTimer=setTimeout((function(){e.logger.warn("signal "+e.name+" wait for pong timeout, reconnect"),e.close(),e.reconnect()}),15e3)}},{key:"_resetPing",value:function(){this._stopPing(),this._startPing(this.pingInterval)}},{key:"_stopPing",value:function(){clearInterval(this.pingTimer),clearTimeout(this.pongTimer),this.pingTimer=null,this.pongTimer=null}},{key:"close",value:function(){var e=this;this.logger.info("close signal "+this.name),this._stopPing(),e._ws&&e._ws.close(1e3,"normal close")}},{key:"reconnect",value:function(){this._ws&&(this.logger.info("reconnect signal "+this.name),this._ws.reconnect())}},{key:"destroy",value:function(){this.close(),this._ws=null,this.removeAllListeners()}},{key:"connected",get:function(){return!!this._ws&&this._ws.readyState===o.default.OPEN}}]),t}(i.default);t.default=c,e.exports=t.default},980:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},o=n(304);var a=i({},((r=o)&&r.__esModule?r:{default:r}).default,{p2pBlackList:["aac","mp3","vtt","webvtt","key"],scheduledBySegId:!1,simultaneousTargetPeers:2,maxSubscribeLevel:3,live:!0,waitForPeer:!1,waitForPeerTimeout:4.5,httpLoadTime:2,sharePlaylist:!1,useHttpRange:!0});a.validateSegment=function(e,t){return!0},t.default=a,e.exports=t.default},227:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},o=n(784),a=(r=o)&&r.__esModule?r:{default:r};t.default=i({},a.default,{SCH_DCHAVE:"SCH_DCHAVE",DC_SUBSCRIBE:"SUBSCRIBE",DC_UNSUBSCRIBE:"UNSUBSCRIBE",DC_SUBSCRIBE_ACCEPT:"SUBSCRIBE_ACCEPT",DC_SUBSCRIBE_REJECT:"SUBSCRIBE_REJECT",DC_SUBSCRIBE_LEVEL:"SUBSCRIBE_LEVEL"}),e.exports=t.default},982:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=f(n(204)),o=n(57),a=f(n(893)),s=f(n(659)),u=f(n(3)),l=f(n(227)),c=n(901);function f(e){return e&&e.__esModule?e:{default:e}}var d=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));n.logger=e.logger;var r=window.__p2p_loader__,i=r.scheduler,a=r.fetcher,u=r.p2pBlackList,l=r.isHlsV0;return n.isHlsV0=l,n.bufMgr=e.bufMgr,n.xhrLoader=new e.loader(e),n.p2pEnabled=e.p2pEnabled,n.isLive=e.live,n.scheduler=i,n.fetcher=a,n.segmentId=e.segmentId,n.blockTypes=u,n.forbidden=a.forbidden,n.multiBitrate=n.scheduler instanceof s.default,n.stats=n.xhrLoader.stats||(0,o.createLoadStats)(),n.waitTimer=null,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"destroy",value:function(){this.xhrLoader.destroy()}},{key:"abort",value:function(){this.xhrLoader.abort()}},{key:"load",value:function(e,t,n){var r=this,i=this.logger,a=this.scheduler,s=e.frag;this.isHlsV0||(s.stats=this.stats);var f=e.frag.segId;if(!f){var d=void 0;e.rangeEnd&&(d="bytes="+e.rangeStart+"-"+(e.rangeEnd-1)),f=e.frag.segId=this.segmentId(String(s.level),s.sn,s.url,d)}if(!s.url||(0,o.isBlockType)(s.url,this.blockTypes))return i.info("HTTP load blockType "+s.url),e.frag.loadByHTTP=!0,this.xhrLoader.load(e,t,n);if(!this.forbidden)if(this.fetcher.increMediaRequests(),t.maxRetry=2,this.p2pEnabled&&this.bufMgr.hasSegOfId(f)){i.info("bufMgr found seg sn "+s.sn+" segId "+f);var h=this.bufMgr.getSegById(f),p=(0,c.copyBuffer)(h.data),g=new Uint8Array(p).buffer,v={url:e.url,data:g};(0,o.updateLoadStats)(this.stats,h.size),s.loaded=h.size,s.loadByP2P=!0,e.frag.fromPeerId=h.fromPeerId,(0,u.default)((function(){!r.isHlsV0&&n.onProgress&&n.onProgress(r.stats,e,v.data),n.onSuccess(v,r.stats,e)}))}else if(this.p2pEnabled&&a.hasAndSetTargetPeer(this.multiBitrate?s.segId:s.sn))this.loadFragByP2p(e,t,n,f);else{var _=a.mBufferedDuration;if(i.info("fragLoader load "+f+" at "+s.sn+" level "+s.level+" buffered "+_),this.isLive&&a.hasIdlePeers&&_>6.5&&a.shouldWaitForNextSeg()){var y=_-6.5;y>5.5&&(y=5.5);var b=function i(o){f===o&&(a.off(l.default.SCH_DCHAVE,i),clearTimeout(r.waitTimer),a.hasAndSetTargetPeer(r.multiBitrate?s.segId:s.sn)?r.loadFragByP2p(e,t,n,f):r.loadFragByHttp(e,t,n,f))};i.info("wait peer have for "+y+"s"),a.on(l.default.SCH_DCHAVE,b),this.waitTimer=setTimeout((function(){a.notifyAllPeers(s.sn,f),r.loadFragByHttp(e,t,n,f),a.off(l.default.SCH_DCHAVE,b)}),1e3*y)}else this.loadFragByHttp(e,t,n,f)}}},{key:"loadFragByHttp",value:function(e,t,n,r){var i=this;this.scheduler.isReceiver=!1;var o=this.logger,s=e.frag;if(this.isHlsV0){var u=n.onSuccess;n.onSuccess=function(e,t,n){if(!i.bufMgr.hasSegOfId(r)){var l=(0,c.copyBuffer)(e.data),f=new a.default(s.sn,r,l,i.fetcher.peerId);i.bufMgr.putSeg(f)}i.fetcher.reportFlow(t.total);var d=t.tload-t.trequest;o.info("HTTP loaded "+r+" time "+d+"ms"),u(e,t,n)}}else if(n.onProgress){var l=n.onProgress;n.onProgress=function(e,t,n){if(!i.bufMgr.hasSegOfId(r)){var u=(0,c.copyBuffer)(n),f=new a.default(s.sn,r,u,i.fetcher.peerId);i.bufMgr.putSeg(f)}i.fetcher.reportFlow(e.total),s.loaded=e.total;var d=e.loading.end-e.loading.start;o.info("HTTP loaded "+r+" time "+d+"ms"),l(e,t,n)}}e.frag.loadByHTTP=!0,this.xhrLoader.load(e,t,n)}},{key:"loadFragByP2p",value:function(e,t,n,r){var i=this,o=this.logger,s=e.frag;this.scheduler.load(e,t,n);var u=n.onSuccess,l=n.onTimeout;n.onTimeout=function(e,a){o.warn("P2P timeout switched to HTTP load "+s.relurl+" at "+s.sn),n.onSuccess=u,i.loadFragByHttp(a,t,n,r),n.onTimeout=l},n.onSuccess=function(e,t,l){if(!i.bufMgr.hasSegOfId(r)){var f=(0,c.copyBuffer)(e.data),d=new a.default(s.sn,r,f,s.fromPeerId||i.fetcher.peerId);i.bufMgr.putSeg(d)}s.loadByP2P||i.fetcher.reportFlow(t.total),s.loaded=t.loaded,o.info((s.loadByP2P?"P2P":"HTTP")+" loaded segment id "+r),!i.isHlsV0&&n.onProgress&&n.onProgress(t,l,e.data),u(e,t,l)}}}]),t}(i.default);t.default=d,e.exports=t.default},659:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var a=i.get;return void 0!==a?a.call(r):void 0},o=c(n(893)),a=c(n(227)),s=c(n(381)),u=n(57),l=n(901);function c(e){return e&&e.__esModule?e:{default:e}}function f(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var d=function(e){function t(e,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return r.logger.info("use IdScheduler"),r.sequential=!1,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"load",value:function(e,t,n){this.isReceiver=!0;var r=this.logger;this.context=e;var i=e.frag,o=i.segId,a=i.sn;this.callbacks=n,this.stats=(0,u.createLoadStats)(),this.criticalSeg={sn:a,segId:o,targetPeers:[].concat(f(this.targetPeers.map((function(e){return e.remotePeerId}))))};var s=this.mBufferedDuration-this.config.httpLoadTime;s>this.dcDownloadTimeout&&(s=this.dcDownloadTimeout);var l=!0,c=!1,d=void 0;try{for(var h,p=this.targetPeers[Symbol.iterator]();!(l=(h=p.next()).done);l=!0){var g=h.value;g.downloading||(r.info("request criticalSeg segId "+o+" at "+a+" from "+g.remotePeerId+" timeout "+s),g.requestDataById(o,a,!0)),this.requestingMap.set(o,g.remotePeerId)}}catch(e){c=!0,d=e}finally{try{!l&&p.return&&p.return()}finally{if(c)throw d}}this.criticaltimeouter=setTimeout(this.criticaltimeout.bind(this,!0),1e3*s),this.targetPeers=[]}},{key:"onBufferManagerLost",value:function(e,t,n){this.bitset.delete(t),this.bitCounts.delete(t)}},{key:"destroy",value:function(){i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.logger.warn("destroy IdScheduler")}},{key:"_setupDC",value:function(e){var n=this;i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_setupDC",this).call(this,e);var r=this.logger,s=this.config;e.on(a.default.DC_HAVE,(function(t){if(t.seg_id&&e.bitset){var r=t.seg_id;e.bitset.has(r)||(e.bitset.add(r),n.bitset.has(r)||n._increBitCounts(r)),s.live&&(0,l.trimSet)(e.bitset,20),n.emit(a.default.SCH_DCHAVE,t.seg_id)}})).on(a.default.DC_LOST,(function(t){if(t.seg_id&&e.bitset){var r=t.seg_id;e.bitset.has(r)&&(e.bitset.delete(r),n._decreBitCounts(r))}})).on(a.default.DC_PIECE,(function(e){e.ext&&e.ext.incompletes>=2||n.notifyAllPeers(e.sn,e.seg_id)})).on(a.default.DC_PIECE_NOT_FOUND,(function(t){var i=t.seg_id;n.criticalSeg&&n.criticalSeg.segId===i&&(1===n.criticalSeg.targetPeers.length?(clearTimeout(n.criticaltimeouter),r.info("DC_PIECE_NOT_FOUND"),n.criticalSeg=null,n.callbacks.onTimeout(n.stats,n.context,null)):n.criticalSeg.targetPeers=n.criticalSeg.targetPeers.filter((function(t){return t!==e.remotePeerId}))),e.bitset.delete(i),n.requestingMap.delete(i),n._decreBitCounts(i),e.checkIfNeedChoke(!0)})).on(a.default.DC_RESPONSE,(function(a,s){var u=a.segId,l=a.sn,c=a.data,f=n.criticalSeg&&n.criticalSeg.segId===u;if(n.config.validateSegment(u,c))if(n.notifyAllPeers(l,u),i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reportDCTraffic",n).call(n,u,a.size,s),f){r.info("receive criticalSeg seg_id "+u),clearTimeout(n.criticaltimeouter),n.criticaltimeouter=null,e.miss=0;var d=n.stats;d.tfirst=d.loading.first=Math.max(d.trequest,performance.now()),d.tload=d.loading.end=d.tfirst,d.loaded=d.total=c.byteLength,n.criticalSeg=null;var h=n.context.frag;h.fromPeerId=e.remotePeerId,h.loadByP2P=!0,n.callbacks.onSuccess({data:c},d,n.context)}else{if(n.bitset.has(u))return;var p=new o.default(l,u,c,e.remotePeerId);n.bufMgr.putSeg(p),n.updateLoaded(u)}else r.warn("segment "+u+" validate failed"),f&&(clearTimeout(n.criticaltimeouter),n.criticaltimeout());n.requestingMap.delete(u)})).on(a.default.DC_REQUEST,(function(t){n.isUploader=!0;var i=t.seg_id,o=null;if(n.requestingMap.has(i)&&(o=n.getPeerLoadedMore(i)),n.bufMgr.hasSegOfId(i)){r.info("found seg from bufMgr");var s=n.bufMgr.getSegById(i);e.sendBuffer(s.sn,s.segId,s.data)}else o&&o.downloading&&o.pieceMsg.seg_id===i?(r.info("target had partial buffer, wait for remain"),e.sendPartialBuffer(o.pieceMsg,o.bufArr,{from:"WaitForPartial",incompletes:1}),function(t,n){t.addStreamListener(!1,n.remotePeerId,(function(t,r,i,o,a){i?n.sendMsgPieceAbort(o):n.send(o),a&&(e.uploading=!1)}))}(o,e)):(r.info("peer request "+i+" wait for seg"),n.bufMgr.once(""+a.default.BM_ADDED_SEG_+i,(function(n){n?(r.info("peer request notify seg "+i),e.sendBuffer(n.sn,n.segId,n.data)):e.sendPieceNotFound(t.sn,i)})))}))}},{key:"_setupEngine",value:function(){var e=this;this.engine.on(a.default.FRAG_LOADING,(function(t,n,r){e.loadingSegId=n,e.isHlsV0&&r&&e.notifyAllPeers(t,n)})).on(a.default.FRAG_LOADED,(function(t,n,r,i,o){n&&(!e.isHlsV0&&o&&e.notifyAllPeers(t,n),e.updateLoaded(n))}))}}]),t}(s.default);t.default=d,e.exports=t.default},381:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var a=i.get;return void 0!==a?a.call(r):void 0},o=l(n(673)),a=l(n(227)),s=n(901),u=n(9);function l(e){return e&&e.__esModule?e:{default:e}}var c=function(e){function t(e,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return r.targetPeers=[],r.mBufferedDuration=0,r.loadingSegId="",r.allowP2pLimit=n.httpLoadTime+2,r.playlistInfo=new Map,r.subscribeMode=!1,r.subscribeLevel=0,r.subscribers=[],r.subscribeParent=null,r.subscriberEdgeSN=0,r.isUploader=!1,r.isReceiver=!1,r.isHlsV0=n.isHlsV0,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"hasAndSetTargetPeer",value:function(e){var t=this.logger,n=this.config;if(this.criticalSeg&&t.warn("scheduler still loading "+JSON.stringify(this.criticalSeg)),this.waitForPeer){if(this.peersHas(e)){var r=!0,i=!1,o=void 0;try{for(var a,s=this.peerManager.getAvailablePeers()[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var u=a.value;if(u.bitset.has(e))return t.info("found "+e+" from peer "+u.remotePeerId),this.targetPeers.push(u),!0}}catch(e){i=!0,o=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}}return 0!==this.waitingPeers&&this.waitingPeers===this.peersNum?(t.info("all connected no need wait"),!1):(t.warn("wait for peer to load "+e),this.requestingMap.setPeerUnknown(e),!0)}var l=this.bufferedDuration;if(this.subscribeMode){var c=this.subscribeParent,f=c.remotePeerId;return c.bitset.has(e)?c.downloading?this._searchAvailablePeers(e):(t.info("found "+e+" from parent "+f),this.targetPeers.push(this.subscribeParent),!0):!(l<=3.5)&&(t.info("under subscribe to "+f),this.requestingMap.set(e,f),!0)}if(l<=this.allowP2pLimit)return!1;if(this.requestingMap.has(e)){var d=this.requestingMap.getOnePeerId(e),h=this.peerManager.getPeer(d);return h?!(performance.now()-h.timeSendRequest>3e3&&!h.shouldWaitForRemain(1e3*(l-n.httpLoadTime)))||!!this._searchAvailablePeers(e,1)&&(t.warn(d+" prefetch timeout at "+e),this.targetPeers.push(h),this.requestingMap.delete(e),!0):this._searchAvailablePeers(e)}return this._searchAvailablePeers(e)}},{key:"_searchAvailablePeers",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if(!this.hasIdlePeers||!this.peersHas(e))return!1;var n=0,r=!0,i=!1,o=void 0;try{for(var a,s=this.peerManager.getPeersOrderByWeight()[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var u=a.value;if(u.bitset.has(e)&&(this.logger.info("found "+e+" from peer "+u.remotePeerId),this.targetPeers.push(u),++n===t||n===this.config.simultaneousTargetPeers))return!0}}catch(e){i=!0,o=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return this.targetPeers.length>0}},{key:"notifyAllPeers",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=this.config.live,i=t;if(this.sequential&&(i=e),!this.bitset.has(i)){var o=!0,a=!1,u=void 0;try{for(var l,c=this.peerManager.getPeerValues()[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var f=l.value;if(!f.notifySet.has(i)&&!f.bitset.has(i)){if(r&&(this.subscribers.includes(f.remotePeerId)||this.subscribeParent&&f.remotePeerId===this.subscribeParent.remotePeerId))continue;if(!n.includes(f.remotePeerId)&&(f.sendMsgHave(e,t),f.notifySet.add(i),r)){var d=20;if(this.sequential){var h=e-d;h>0&&f.notifySet.delete(h)}else(0,s.trimSet)(f.notifySet,d)}}}}catch(e){a=!0,u=e}finally{try{!o&&c.return&&c.return()}finally{if(a)throw u}}}}},{key:"updateLoaded",value:function(e){this.bitset.has(e)||(this.bitset.add(e),this.bitCounts.has(e)&&this.bitCounts.delete(e))}},{key:"deletePeer",value:function(e){var n=this;this.peerManager.hasPeer(e.remotePeerId)&&e.bitset.forEach((function(e){n._decreBitCounts(e)})),this.cleanRequestingMap(e.remotePeerId),i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"deletePeer",this).call(this,e)}},{key:"_setupDC",value:function(e){var n=this;i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_setupDC",this).call(this,e);this.logger;e.on(a.default.DC_PIECE,(function(e){n.criticalSeg&&n.criticalSeg.segId===e.seg_id&&(n.stats.tfirst=Math.max(performance.now(),n.stats.trequest))})).on(a.default.DC_PIECE_DATA,(function(t,r,i,o,a){1===o&&e.pieceMsg.ext&&e.pieceMsg.ext.incompletes>=2&&n.notifyAllPeers(t,r)}))}},{key:"loadRemainBufferByHttp",value:function(e,n){var r=this,o=this.context.frag.url,a=this.config.xhrSetup,l=u.Buffer.concat(e.bufArr);i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reportDCTraffic",this).call(this,n,l.byteLength,0);var c="bytes=";if(this.context.rangeEnd){var f=Number(this.context.rangeStart),d=Number(this.context.rangeEnd);c=""+c+(f+l.byteLength)+"-"+(d-1)}else c=""+c+l.byteLength+"-";this.logger.info("continue download from "+o+" range: "+c),(0,s.performRangeRequest)(o,c,a).then((function(t){var n=u.Buffer.from(t);r.engine.fetcher.reportFlow(n.byteLength);var i=u.Buffer.concat([l,n]),o=new Uint8Array(i).buffer,a=r.stats;a.tfirst=a.loading.first=Math.max(a.trequest,performance.now()),a.tload=a.loading.end=a.tfirst,a.loaded=a.total=i.byteLength;var s=r.context.frag;s.fromPeerId=e.remotePeerId,s.loadByP2P=!0,r.callbacks.onSuccess({data:o},a,r.context)})).catch((function(e){r.logger.error("http partial download error "+e),r.callbacks.onTimeout(r.stats,r.context,null)}))}},{key:"broadcastPlaylist",value:function(e,t){if(this.config.live){var n=(0,s.getMaxSequence)(t),r=!0,i=!1,o=void 0;try{for(var a,u=this.peerManager.getPeerValues()[Symbol.iterator]();!(r=(a=u.next()).done);r=!0){a.value.sendMsgPlaylist(e,t,n)}}catch(e){i=!0,o=e}finally{try{!r&&u.return&&u.return()}finally{if(i)throw o}}this.playlistInfo.set(e,{seq:n})}}},{key:"getPlaylistFromPeer",value:function(e){if(!this.config.live)return null;var t=this.playlistInfo.get(e).seq,n=!0,r=!1,i=void 0;try{for(var o,a=this.peerManager.getPeerValues()[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value.getLatestPlaylist(e,t);if(s)return s}}catch(e){r=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}return null}},{key:"_handlePieceAborted",value:function(e){this.criticalSeg&&this.criticalSeg.targetPeers.includes(e)?1===this.criticalSeg.targetPeers.length?(clearTimeout(this.criticaltimeouter),this.criticaltimeout(),this.cleanRequestingMap(e)):this.criticalSeg.targetPeers=this.criticalSeg.targetPeers.filter((function(t){return t!==e})):this.cleanRequestingMap(e)}},{key:"criticaltimeout",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.logger,n=this.config;if(this.waitForPeer&&(this.waitForPeer=!1),this.criticalSeg){var r=this.criticalSeg.sn,i=this.criticalSeg.segId;this.sequential&&(i=r),t.info("critical request sn "+i+" timeout");var o=void 0;this.subscribeMode?o=this.subscribeParent:this.requestingMap.has(i)&&(o=this.getPeerLoadedMore(i));var a=!1;if(o&&(a=!o.loadtimeout()),a)t.info("p2p download completed");else{var s=1e3*n.httpLoadTime-500;if(e&&o&&o.shouldWaitForRemain(s))return t.info("wait for peer load remain of "+r),void(this.criticaltimeouter=setTimeout(this.criticaltimeout.bind(this),s+200));n.httpRangeSupported&&o&&o.bufArr.length>0&&o.segId===this.criticalSeg.segId?this.loadRemainBufferByHttp(o,i):this.callbacks.onTimeout(this.stats,this.context,null),this.requestingMap.delete(i),n.live&&o&&o.resetContinuousHits(),this.subscribeParent&&this._unsubscribe("subscribe timeout for "+r),this.criticalSeg=null,this.criticaltimeouter=null}}}},{key:"shouldWaitForNextSeg",value:function(){var e=void 0;return e=!(this.subscribers.length>0||this.isUploader)&&(!!this.isReceiver||(0,s.randomNum)(0,100)>20),this.isReceiver=this.isUploader=!1,e}},{key:"getStatsForPeer",value:function(){var e=this.subscribers,t=e.length>0?e.length:void 0,n=this.engine.currentLevel,r=this.engine.media.currentTime;return{children:t,pos:this.config.live?void 0:Math.round(r),level:n}}},{key:"bufferedDuration",get:function(){for(var e=this.engine.media,t=0,n=e.currentTime,r=e.buffered,i=r.length-1;i>=0;i--)if(n>=r.start(i)&&n<=r.end(i)){t=r.end(i)-n;break}return this.logger.info("bufferedDuration "+t),this.mBufferedDuration=t,t>0?t:0}}]),t}(o.default);t.default=c,e.exports=t.default},373:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var a=i.get;return void 0!==a?a.call(r):void 0},o=f(n(893)),a=f(n(227)),s=f(n(381)),u=f(n(427)),l=n(57),c=f(n(3));function f(e){return e&&e.__esModule?e:{default:e}}function d(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var h=function(e){function t(e,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return r.logger.info("use SnScheduler"),r.sequential=!0,r.currPlaySN=0,r.currLostSN=-1,r.nextLostSN=-1,r.config.live?r.maxPrefetchCount=3:(r.maxPrefetchCount=150,r.startCheckPeersTimer()),r.waitForPeer=n.waitForPeer||!1,r.waitingPeers=0,r.waitForPeer&&(r.waitForPeerTimer=setTimeout((function(){r.waitForPeer=!1}),1e3*(n.waitForPeerTimeout+2))),r.estimatedSize=1e6,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"notifySubscribeLevel",value:function(){var e=this;this.subscribers.forEach((function(t){var n=e.peerManager.getPeer(t);n&&n.sendSubscribeLevel(e.subscribeLevel)}))}},{key:"updatePlaySN",value:function(e){this.currPlaySN=e}},{key:"checkPeers",value:function(){var e=this.logger,t=this.config,n=t.live;if(!this.waitForPeer&&0!==this.bitCounts.size&&!(!n&&this.nextLostSN>=0&&this.nextLostSN>=this.currPlaySN-10)&&this.hasPeers)if(this.mBufferedDuration<this.allowP2pLimit)e.info("low buffer time, skip prefetch");else{var r=this.peerManager.getPeersOrderByWeight();if(0!==r.length){var i=[],o=t.prefetchNum,a=t.endSN,s=t.startSN;n&&(o=1);var u=0,l=n?this.loadingSN+1:this.loadingSN+2;if(!n)if(this.loadingSN>=a&&!this.bufMgr.overflowed)l=s;else{var c=Math.min.apply(Math,d(r.filter((function(e){return e.endSN>=l})).map((function(e){return e?e.startSN:1/0}))));if(!isFinite(c))return;l<c&&(l=c)}for(;i.length<o&&i.length<r.length&&u<this.maxPrefetchCount;){if(!n&&l>a)return;if(this.bitset.has(l))l++;else{if(l!==this.loadingSN&&this.bitCounts.has(l)&&!this.requestingMap.has(l)){var f=!0,h=!1,p=void 0;try{for(var g,v=r[Symbol.iterator]();!(f=(g=v.next()).done);f=!0){var _=g.value;if(!i.includes(_)&&_.bitset.has(l)){_.requestDataBySN(l,!1),e.info("request prefetch "+l+" from peer "+_.remotePeerId+" downloadNum "+_.downloadNum),i.push(_),this.requestingMap.set(l,_.remotePeerId);break}}}catch(e){h=!0,p=e}finally{try{!f&&v.return&&v.return()}finally{if(h)throw p}}}u++,l++}}this.loadedPeerNum=i.length}}}},{key:"addPeer",value:function(e){if(i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"addPeer",this).call(this,e),this.waitForPeer&&this.criticalSeg){var n=this.criticalSeg.segId,r=this.criticalSeg.sn,o=e.remotePeerId,a=this.requestingMap;a.checkIfPeerUnknown(r)&&(e.bitset.has(r)?(this.logger.info("found initial seg "+r+" from peer "+o),a.set(r,o),e.requestDataById(n,r,!0)):this.waitingPeers===this.peersNum&&this.criticaltimeout())}}},{key:"deletePeer",value:function(e){if(i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"deletePeer",this).call(this,e),this.subscribeMode&&e.remotePeerId===this.subscribeParent.remotePeerId){var n="subscribe parent is leaved";this.logger.warn(n),this._unsubscribe(n),this.criticaltimeout()}}},{key:"load",value:function(e,t,n){this.isReceiver=!0;var r=this.logger,i=this.config;this.context=e;var o=e.frag,a=o.segId,s=o.sn;this.callbacks=n,this.stats=(0,l.createLoadStats)(),this.criticalSeg={sn:s,segId:a},this.targetPeers.length>0?this.criticalSeg.targetPeers=[].concat(d(this.targetPeers.map((function(e){return e.remotePeerId})))):this.criticalSeg.targetPeers=[].concat(d(this.requestingMap.getAllPeerIds(s)));var u=this.mBufferedDuration-i.httpLoadTime;if(this.waitForPeer?u=i.waitForPeerTimeout:u>this.dcDownloadTimeout&&(u=this.dcDownloadTimeout),this.requestingMap.has(s))r.info("wait for criticalSeg segId "+a+" at "+s+" timeout "+u);else{var c=!0,f=!1,h=void 0;try{for(var p,g=this.targetPeers[Symbol.iterator]();!(c=(p=g.next()).done);c=!0){var v=p.value;v.downloading||(r.info("request criticalSeg segId "+a+" at "+s+" from "+v.remotePeerId+" timeout "+u),v.requestDataById(a,s,!0)),this.requestingMap.set(s,v.remotePeerId)}}catch(e){f=!0,h=e}finally{try{!c&&g.return&&g.return()}finally{if(f)throw h}}}this.criticaltimeouter=setTimeout(this.criticaltimeout.bind(this,!0),1e3*u),this.targetPeers=[]}},{key:"onBufferManagerSegAdded",value:function(e){this._sendSegmentToSubscribers(e)}},{key:"onBufferManagerLost",value:function(e,t,n){this.currLostSN=e,n&&(this.nextLostSN=n),this.bitset.delete(e),this.bitCounts.delete(e)}},{key:"destroy",value:function(){i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),clearTimeout(this.waitForPeerTimer),this.logger.warn("destroy SnScheduler")}},{key:"_setupDC",value:function(e){var n=this;i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_setupDC",this).call(this,e);var r=this.logger,s=this.config;e.on(a.default.DC_HAVE,(function(t){if(t.sn&&e.bitset&&t.sn&&t.sn>=0){var r=t.sn;if(e.bitset.has(r)||(e.bitset.add(r),n.bitset.has(r)||n._increBitCounts(r)),s.live){var i=r-20;i>0&&e.bitset.delete(i)}n.emit(a.default.SCH_DCHAVE,t.seg_id),(0,c.default)((function(){!s.live||n.criticalSeg||n.subscribeMode||n.checkPeers()}))}})).on(a.default.DC_LOST,(function(t){if(t.sn&&e.bitset){var r=t.sn;e.bitset.has(r)&&(e.bitset.delete(r),n._decreBitCounts(r))}})).on(a.default.DC_PIECE,(function(t){n.subscribers.length>0&&t.sn>n.subscriberEdgeSN&&(n._sendPieceToSubscribers(t.sn,t.seg_id,!1,!1,t),e.addStreamListener(!1,void 0,(function(e,t,r,i,o){r?n._sendPieceToSubscribers(e,t,!1,!0,i):n._sendPieceToSubscribers(e,t,!0,!1,i,o)})),n.subscriberEdgeSN=t.sn),t.ext&&t.ext.incompletes>=2||n.notifyAllPeers(t.sn,t.seg_id)})).on(a.default.DC_PIECE_NOT_FOUND,(function(t){var i=t.sn;n.criticalSeg&&n.criticalSeg.sn===i&&(1===n.criticalSeg.targetPeers.length?(clearTimeout(n.criticaltimeouter),r.info("DC_PIECE_NOT_FOUND "+i),n.criticalSeg=null,n.callbacks.onTimeout(n.stats,n.context,null)):n.criticalSeg.targetPeers=n.criticalSeg.targetPeers.filter((function(t){return t!==e.remotePeerId}))),e.bitset.delete(i),s.live&&e.resetContinuousHits(),n.requestingMap.delete(i),n._decreBitCounts(i),e.checkIfNeedChoke(!0)})).on(a.default.DC_RESPONSE,(function(a,s){var u=n.config,l=a.segId,c=a.sn,f=a.data,d=n.criticalSeg&&n.criticalSeg.segId===l;if(u.validateSegment(l,f))if(n.notifyAllPeers(c,l),i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reportDCTraffic",n).call(n,c,a.size,s),d){r.info("receive criticalSeg seg_id "+l),clearTimeout(n.criticaltimeouter),n.criticaltimeouter=null,e.miss=0;var h=n.stats;h.tfirst=h.loading.first=Math.max(h.trequest,performance.now()),h.tload=h.loading.end=h.tfirst,h.loaded=h.total=f.byteLength,n.criticalSeg=null;var p=n.context.frag;p.fromPeerId=e.remotePeerId,p.loadByP2P=!0,n.callbacks.onSuccess({data:f,url:n.context.url},h,n.context),e.increContinuousHits(),u.maxSubscribeLevel&&u.live&&!n.subscribeMode&&e.continuousHits>7&&e.sendSubscribe()}else{if(n.bitset.has(c))return;var g=new o.default(c,l,f,e.remotePeerId);n.bufMgr.putSeg(g),n.updateLoaded(c)}else r.warn("segment "+l+" validate failed"),d&&(clearTimeout(n.criticaltimeouter),n.criticaltimeout());n.requestingMap.delete(c),!u.live||n.criticalSeg||n.subscribeMode||n.checkPeers()})).on(a.default.DC_REQUEST,(function(t){var i=t.sn;n.isUploader=!0,n.subscribers.includes(e.remotePeerId)&&(e.subscribeEdgeSN=i);var o=t.seg_id;o||(o=n.bufMgr.getSegIdBySN(i));var s=null;if(n.requestingMap.has(i)?s=n.getPeerLoadedMore(i):n.subscribeMode&&(s=n.subscribeParent),n.bufMgr.hasSegOfId(o)){r.info("found seg from bufMgr");var u=n.bufMgr.getSegById(o);e.sendBuffer(u.sn,u.segId,u.data,{from:"SegmentFromCache"})}else s&&s.downloading&&s.pieceMsg.sn===i?(r.info("target had "+s.bufArr.length+" packets, wait for remain from upstream "+s.remotePeerId),e.sendPartialBuffer(s.pieceMsg,s.bufArr,{from:"WaitForPartial",incompletes:1}),function(e,t){e.addStreamListener(!1,t.remotePeerId,(function(e,n,r,i,o){r?t.sendMsgPieceAbort(i):t.send(i),o&&(t.uploading=!1)}))}(s,e)):i>=n.loadingSN?(r.info("peer request "+i+" wait for seg"),n.bufMgr.once(""+a.default.BM_ADDED_SN_+i,(function(t){t?(r.info("peer request notify seg "+t.sn),e.sendBuffer(t.sn,t.segId,t.data,{from:"NotifySegment"})):e.sendPieceNotFound(i,o)}))):e.sendPieceNotFound(i,o)})).on(a.default.DC_SUBSCRIBE,(function(){if(n.config.live){var t=n.subscribers.length,i=n.config.maxSubscribeLevel;if(0===i)e.sendSubscribeReject("subscribe disabled");else if(t>=25)e.sendSubscribeReject("too many subscribers");else if(n.subscribeLevel>=i)e.sendSubscribeReject("subscribe level reach "+n.subscribeLevel);else if(n.subscribers.indexOf(e.remotePeerId)>=0)e.sendSubscribeReject("subscriber already exist");else{if(t>=2){var o=[];if(n.subscribers.forEach((function(e){var t=n.peerManager.getPeer(e).uploadSpeed;t&&o.push(t)})),!u.default.evaluatePeersSpeed(o,n.estimatedSize))return void e.sendSubscribeReject("Insufficient upload capability")}n.subscribers.push(e.remotePeerId),r.info("subscribers add "+e.remotePeerId),e.sendSubscribeAccept(n.subscribeLevel)}}})).on(a.default.DC_UNSUBSCRIBE,(function(t){var i=n.subscribers.indexOf(e.remotePeerId);-1!==i&&(r.info("subscribers remove "+e.remotePeerId+" reason "+t.reason),n.subscribers.splice(i,1))})).on(a.default.DC_SUBSCRIBE_ACCEPT,(function(t){if(!n.subscribeMode){var r=t.level||0;n.subscribeMode=!0,n.subscribeLevel=r+1,n.subscribeParent=e,n.notifySubscribeLevel()}})).on(a.default.DC_SUBSCRIBE_REJECT,(function(t){r.warn("subscribe rejected, reason "+t.reason),e.resetContinuousHits()})).on(a.default.DC_SUBSCRIBE_LEVEL,(function(e){if(n.subscribeMode){var t=e.level||0;n.subscribeLevel=t+1,r.info("set subscribe level to "+n.subscribeLevel),n.notifySubscribeLevel()}}))}},{key:"_setupEngine",value:function(){var e=this;this.engine.on(a.default.FRAG_LOADING,(function(t,n,r){e.loadingSN=t,e.loadingSegId=n,e.isHlsV0&&r&&e.notifyAllPeers(t,n)})).on(a.default.FRAG_LOADED,(function(t,n,r,i,o){e.config.live&&(e.estimatedSize=r),!e.isHlsV0&&o&&e.notifyAllPeers(t,n),e.updateLoaded(t)})).on(a.default.FRAG_CHANGED,(function(t,n){e.updatePlaySN(t)}))}},{key:"notifyPeersLoaded",value:function(e){this.logger.info("notifyPeersLoaded "+e),this.waitForPeer&&(0===e?this.criticaltimeout():this.waitingPeers=e)}},{key:"_unsubscribe",value:function(e){this.logger.warn("unsubscribe to "+this.subscribeParent.remotePeerId),this.subscribeParent.sendUnsubscribe(e),this.subscribeParent=null,this.subscribeLevel=0,this.subscribeMode=!1,this.notifySubscribeLevel()}},{key:"_sendSegmentToSubscribers",value:function(e){var t=this,n=e.sn,r=e.segId,i=e.data;this.subscribers=this.subscribers.filter((function(e){var o=t.peerManager.getPeer(e);return o?(o.uploading||o.bitset.has(n)||(t.logger.info("send seg "+r+" to subscriber "+e),o.uploading=!0,o.sendBuffer(n,r,i,{from:"SegmentToSubscribers"}),o.bitset.add(n)),!0):(t.logger.info("subscribers remove "+e),!1)}))}},{key:"_sendPieceToSubscribers",value:function(e,t,n,r,i,o){var a=this;this.subscribers=this.subscribers.filter((function(t){var s=a.peerManager.getPeer(t);if(s){if(n&&e===s.pieceMsg.sn)s.send(i),o&&(s.uploading=!1,s.bitset.add(e));else if(!n)if(r)s.sendMsgPieceAbort(i);else{if(s.uploading||e<=s.subscribeEdgeSN)return!0;s.subscribeEdgeSN=e,s.uploading=!0,s.pieceMsg=i,a.logger.info("downstream msg "+JSON.stringify(i)+" to subscriber "+t),s.sendMsgPiece(i,{from:"PieceToSubscribers",incompletes:1})}return!0}return a.logger.info("subscribers remove "+t),!1}))}}]),t}(s.default);t.default=h,e.exports=t.default},666:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=w(n(622)),a=w(n(980)),s=w(n(982)),u=w(n(564)),l=w(n(233)),c=w(n(23)),f=w(n(227)),d=w(n(542)),h=w(n(702)),p=w(n(979)),g=w(n(522)),v=n(206),_=n(901),y=n(57),b=w(n(373)),m=w(n(659));function w(e){return e&&e.__esModule?e:{default:e}}function P(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function S(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}if(window){if(window.p2ploadedHls)throw new Error("You are loading the p2p library multiple times. Please load it only once.");window.p2ploadedHls=!0}var C=function(e){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};P(this,t);var i=S(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,n));i.config=Object.assign({},a.default,n),i.rangeTested=!1,i.lastLevel=0,i.hlsjs=e,i.config.waitForPeer&&(i.config.trickleICE=!0),i.HLSEvents=e.constructor.Events,i.config.isHlsV0="0"===e.constructor.version.split(".")[0],i.config.xhrSetup=e.config.xhrSetup;var s=i.config,u=s.token,l=s.channelId,c=s.segmentId;u||(u=i.config.channelIdPrefix);var f=function(e){var t=o.default.parseURL(e);return""+(t.netLoc.substr(2)+t.path.substring(0,t.path.lastIndexOf(".")))},h=function(e,t,n,r){var i=n.split("?")[0];return i.startsWith("http")&&(i=i.split("://")[1]),r?i+"|"+r:""+i};l&&"function"==typeof l&&(f=i.makeChannelId(u,l),c||(h=function(e,t,n,r){return e+"-"+t})),c||(i.config.segmentId=h),e.config.segmentId=i.config.segmentId;var p=i.makeSignalId(),g=function t(n,o){var a=i.config,s=o.details,u=s.live;a.live=i.hlsjs.config.live=u,i.browserInfo=r({},i.commonBrowserInfo,{abr:i.multiBitrate||void 0,tag:a.tag||void 0,live:u,type:"hls"}),i.channel=f(e.url)+"|"+p+"["+d.default.VERSION+"]",i.browserInfo.device===v.device.PC_NATIVE&&(i.browserInfo=r({},i.browserInfo,{app:a.appName,bundle:a.appId}));var l=i.initLogger();i.hlsjs.config.logger=l,l.info("channel "+i.channel),u||(a.startSN=s.startSN,a.endSN=s.endSN,l.info("startSN "+s.startSN+" endSN "+s.endSN)),i.eventListened=!1,i._init(i.channel,i.browserInfo),e.off(i.HLSEvents.LEVEL_LOADED,t)};e.on(i.HLSEvents.LEVEL_LOADED,g);var _=function t(n,r){var o=r.levels.length;i.multiBitrate=o>1,e.off(i.HLSEvents.MANIFEST_PARSED,t)};return e.on(i.HLSEvents.MANIFEST_PARSED,_),i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),i(t,null,[{key:"Events",get:function(){return f.default}}]),i(t,[{key:"_init",value:function(e,t){if(this.p2pEnabled){var n=this.multiBitrate||this.config.scheduledBySegId;this.hlsjs.config.p2pEnabled=this.p2pEnabled,this.hlsjs.config.sharePlaylist=this.config.sharePlaylist,this.bufMgr=new c.default(this,this.config,!n),this.hlsjs.config.bufMgr=this.bufMgr,this.media=this.hlsjs.media;var r=new h.default(this,this.config.token,encodeURIComponent(e),this.config.announce||"",t);this.fetcher=r;var i=void 0;i=n?new m.default(this,this.config):new b.default(this,this.config),this.tracker=new l.default(this,r,i,this.config),i.bufferManager=this.bufMgr,this.hlsjs.config.fLoader=s.default,this.config.sharePlaylist&&(this.hlsjs.config.pLoader=u.default),window.__p2p_loader__={scheduler:this.tracker.scheduler,fetcher:r,p2pBlackList:this.config.p2pBlackList,isHlsV0:this.config.isHlsV0},this.trackerTried=!1,this.eventListened||(this.hlsjs.on(this.HLSEvents.FRAG_LOADING,this._onFragLoading.bind(this)),this.hlsjs.on(this.HLSEvents.FRAG_LOADED,this._onFragLoaded.bind(this)),this.hlsjs.on(this.HLSEvents.FRAG_CHANGED,this._onFragChanged.bind(this)),this.hlsjs.on(this.HLSEvents.ERROR,this._onHlsError.bind(this)),this.eventListened=!0),this.setupWindowListeners(),this.trackerTried||this.tracker.connected||!this.config.p2pEnabled||(this.tracker.resumeP2P(),this.trackerTried=!0)}}},{key:"_onFragLoading",value:function(e,t){var n=t.frag,r=n.sn,i=n.segId;if(!(0,y.isBlockType)(n.url,this.config.p2pBlackList)){if(this.logger.debug("loading frag "+r),!i){var o=void 0;n._byteRange&&(o="bytes="+n._byteRange[0]+"-"+n._byteRange[1]);var a=n.url;i=t.frag.segId=this.config.segmentId(String(n.level),n.sn,a,o)}this.emit(f.default.FRAG_LOADING,r,i,t.frag.loadByHTTP)}}},{key:"_onFragLoaded",value:function(e,t){var n=t.frag,r=n.sn,i=n.level,o=n.segId,a=n.loaded,s=n.duration,u=this.config,l=this.logger;(0,y.isBlockType)(t.frag.url,u.p2pBlackList)||(this.emit(f.default.FRAG_LOADED,r,o,a,s,t.frag.loadByHTTP,i),!this.rangeTested&&u.useHttpRange&&((0,_.performRangeRequest)(t.frag.url,"bytes=0-0",u.xhrSetup).then((function(){u.httpRangeSupported=!0,l.info("http range is supported"),u.httpLoadTime-=1.5,u.httpLoadTime<1.5&&(u.httpLoadTime=1.5),u.simultaneousTargetPeers=1})).catch((function(){u.httpRangeSupported=!1,l.warn("http range is not supported")})),this.rangeTested=!0))}},{key:"_onFragChanged",value:function(e,t){if(!(0,y.isBlockType)(t.frag.url,this.config.p2pBlackList)){this.logger.debug("frag changed: "+t.frag.sn);var n=t.frag,r=n.sn,i=n.duration;this.emit(f.default.FRAG_CHANGED,r,i)}}},{key:"_onHlsError",value:function(e,t){var n=this.logger;t.fatal?n.error(t.type+" details "+t.details+" reason "+t.reason):n.warn(t.type+" details "+t.details+" reason "+t.reason);var r=this.hlsjs.constructor.ErrorDetails;switch(t.details){case r.BUFFER_STALLED_ERROR:this.fetcher&&this.fetcher.increRebuffers();break;case r.INTERNAL_EXCEPTION:this.fetcher&&(this.fetcher.errsInternalExpt++,this.fetcher.exptMsg=t.err.message),n.error("INTERNAL_EXCEPTION event "+t.event+" err "+t.err.message),this.emit(f.default.EXCEPTION,(0,g.default)(t.err,"HLSJS_EXPT"))}}},{key:"getExtraForStats",value:function(){var e={};return this.config.live||(e.pos=Math.round(this.media.currentTime)),this.multiBitrate&&this.currentLevel!==this.lastLevel&&(e.level=this.currentLevel+"",this.lastLevel=this.currentLevel),e}},{key:"getExtraForPeersRequest",value:function(){var e={};return this.multiBitrate&&(e.level=this.currentLevel+""),e}},{key:"disableP2P",value:function(){this.logger&&this.logger.warn("disable P2P"),this.p2pEnabled&&(this.p2pEnabled=!1,this.config.p2pEnabled=this.hlsjs.config.p2pEnabled=this.p2pEnabled,this.tracker&&(this.tracker.stopP2P(),this.tracker={},this.fetcher=null,this.bufMgr.destroy(),this.bufMgr=null,this.hlsjs.config.fLoader=this.hlsjs.config.pLoader=this.hlsjs.constructor.DefaultConfig.loader))}},{key:"currentLevel",get:function(){var e=this.hlsjs.currentLevel;return e>=0?e:0}}]),t}(p.default);window&&(window.P2pEngine=window.P2pEngineHls=window.P2PEngineHls=C),t.default=C,e.exports=t.default},564:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=u(n(204)),o=u(n(659)),a=u(n(3)),s=n(57);function u(e){return e&&e.__esModule?e:{default:e}}var l=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));n.logger=e.logger;var r=window.__p2p_loader__.scheduler;return n.isHlsV0=e.isHlsV0,n.xhrLoader=new e.loader(e),n.p2pEnabled=e.p2pEnabled,n.scheduler=r,n.multiBitrate=n.scheduler instanceof o.default,n.stats=n.xhrLoader.stats||(0,s.createLoadStats)(),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"destroy",value:function(){this.xhrLoader.destroy()}},{key:"abort",value:function(){this.xhrLoader.abort()}},{key:"load",value:function(e,t,n){var r=this,i=this.logger,o=e.url,u=o.split("?")[0],l=n.onSuccess;if(n.onSuccess=function(e,t,n){r.scheduler.broadcastPlaylist(u,e.data),l(e,t,n)},this.scheduler.playlistInfo.has(u)){var c=this.scheduler.getPlaylistFromPeer(u);if(c&&c.data){var f=c.data,d=c.seq;i.info("got playlist from peer seq "+d),(0,s.updateLoadStats)(this.stats,f.length);var h={url:o,data:f};return void(0,a.default)((function(){n.onSuccess(h,r.stats,e)}))}}this.xhrLoader.load(e,t,n)}}]),t}(i.default);t.default=l,e.exports=t.default},531:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=a(n(542)),o=a(n(227));function a(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var l=function(e){function t(e,n,r,i,o,a){var l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{};s(this,t);var c=u(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,r,i,o,a,l));return c.continuousHits=0,c.subscribeEdgeSN=0,c}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"resetContinuousHits",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.logger.info("reset "+this.remotePeerId+" continuousHits"),this.continuousHits=e}},{key:"increContinuousHits",value:function(){this.continuousHits++}},{key:"sendSubscribe",value:function(){this.sendJson({event:o.default.DC_SUBSCRIBE})}},{key:"sendUnsubscribe",value:function(e){this.resetContinuousHits(),this.sendJson({event:o.default.DC_UNSUBSCRIBE,reason:e})}},{key:"sendSubscribeReject",value:function(e){this.sendJson({event:o.default.DC_SUBSCRIBE_REJECT,reason:e})}},{key:"sendSubscribeAccept",value:function(e){this.sendJson({event:o.default.DC_SUBSCRIBE_ACCEPT,level:e})}},{key:"sendSubscribeLevel",value:function(e){this.sendJson({event:o.default.DC_SUBSCRIBE_LEVEL,level:e})}}]),t}(i.default);t.default=l,e.exports=t.default},427:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var r=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,null,[{key:"evaluatePeersSpeed",value:function(e,t){var n=t/3500,r=n,i=1.05*n,o=0;return e.forEach((function(e){if(e){if(e<r)return!1;o+=e}})),o/e.length>=i}}]),e}();t.default=r,e.exports=t.default},57:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isBlockType=function(e,t){var n=o.default.parseURL(e),r=n.path.substring(n.path.lastIndexOf(".")+1);return-1!==t.indexOf(r)},t.createLoadStats=function(){var e=performance.now();return{trequest:e,tfirst:0,tload:0,aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:e,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}},t.updateLoadStats=function(e,t){var n,r,i,o,a,s=performance.now();n=s-300,r=s-200,i=s,e.trequest=n,e.tfirst=r,e.tload=i,e.loading={first:n,start:r,end:i},o=a=t,e.loaded=o,e.total=a};var r,i=n(622),o=(r=i)&&r.__esModule?r:{default:r}},204:e=>{"use strict";var t,n="object"==typeof Reflect?Reflect:null,r=n&&"function"==typeof n.apply?n.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,e.exports.once=function(e,t){return new Promise((function(n,r){function i(n){e.removeListener(t,o),r(n)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments))}g(e,t,o,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&g(e,"error",t,n)}(e,i,{once:!0})}))},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var a=10;function s(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function u(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function l(e,t,n,r){var i,o,a,l;if(s(n),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),a=o[t]),void 0===a)a=o[t]=n,++e._eventsCount;else if("function"==typeof a?a=o[t]=r?[n,a]:[a,n]:r?a.unshift(n):a.push(n),(i=u(e))>0&&a.length>i&&!a.warned){a.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=a.length,l=c,console&&console.warn&&console.warn(l)}return e}function c(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=c.bind(r);return i.listener=n,r.wrapFn=i,i}function d(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):p(i,i.length)}function h(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function p(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function g(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function i(o){r.once&&e.removeEventListener(t,i),n(o)}))}}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return u(this)},o.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i="error"===e,o=this._events;if(void 0!==o)i=i&&void 0===o.error;else if(!i)return!1;if(i){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var s=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw s.context=a,s}var u=o[e];if(void 0===u)return!1;if("function"==typeof u)r(u,this,t);else{var l=u.length,c=p(u,l);for(n=0;n<l;++n)r(c[n],this,t)}return!0},o.prototype.addListener=function(e,t){return l(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return l(this,e,t,!0)},o.prototype.once=function(e,t){return s(t),this.on(e,f(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return s(t),this.prependListener(e,f(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,r,i,o,a;if(s(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,i=o;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,a||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,o=Object.keys(n);for(r=0;r<o.length;++r)"removeListener"!==(i=o[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},o.prototype.listeners=function(e){return d(this,e,!0)},o.prototype.rawListeners=function(e){return d(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):h.call(e,t)},o.prototype.listenerCount=h,o.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},760:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>d});var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},r(e,t)};function i(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function o(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a}function a(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(o(arguments[t]));return e}var s=function(e,t){this.target=t,this.type=e},u=function(e){function t(t,n){var r=e.call(this,"error",n)||this;return r.message=t.message,r.error=t,r}return i(t,e),t}(s),l=function(e){function t(t,n,r){void 0===t&&(t=1e3),void 0===n&&(n="");var i=e.call(this,"close",r)||this;return i.wasClean=!0,i.code=t,i.reason=n,i}return i(t,e),t}(s),c=function(){if("undefined"!=typeof WebSocket)return WebSocket},f={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1};const d=function(){function e(e,t,n){var r=this;void 0===n&&(n={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(e){r._debug("open event");var t=r._options.minUptime,n=void 0===t?f.minUptime:t;clearTimeout(r._connectTimeout),r._uptimeTimeout=setTimeout((function(){return r._acceptOpen()}),n),r._ws.binaryType=r._binaryType,r._messageQueue.forEach((function(e){return r._ws.send(e)})),r._messageQueue=[],r.onopen&&r.onopen(e),r._listeners.open.forEach((function(t){return r._callEventListener(e,t)}))},this._handleMessage=function(e){r._debug("message event"),r.onmessage&&r.onmessage(e),r._listeners.message.forEach((function(t){return r._callEventListener(e,t)}))},this._handleError=function(e){r._debug("error event",e.message),r._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),r.onerror&&r.onerror(e),r._debug("exec error listeners"),r._listeners.error.forEach((function(t){return r._callEventListener(e,t)})),r._connect()},this._handleClose=function(e){r._debug("close event"),r._clearTimeouts(),r._shouldReconnect&&r._connect(),r.onclose&&r.onclose(e),r._listeners.close.forEach((function(t){return r._callEventListener(e,t)}))},this._url=e,this._protocols=t,this._options=n,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(e,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CONNECTING",{get:function(){return e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"OPEN",{get:function(){return e.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSING",{get:function(){return e.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSED",{get:function(){return e.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce((function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e}),0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?e.CLOSED:e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()},e.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,n=void 0===t?f.maxEnqueuedMessages:t;this._messageQueue.length<n&&(this._debug("enqueue",e),this._messageQueue.push(e))}},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.dispatchEvent=function(e){var t,n,r=this._listeners[e.type];if(r)try{for(var i=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}(r),o=i.next();!o.done;o=i.next()){var a=o.value;this._callEventListener(e,a)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}return!0},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter((function(e){return e!==t})))},e.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,a(["RWS>"],e))},e.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,n=void 0===t?f.reconnectionDelayGrowFactor:t,r=e.minReconnectionDelay,i=void 0===r?f.minReconnectionDelay:r,o=e.maxReconnectionDelay,a=void 0===o?f.maxReconnectionDelay:o,s=0;return this._retryCount>0&&(s=i*Math.pow(n,this._retryCount-1))>a&&(s=a),this._debug("next delay",s),s},e.prototype._wait=function(){var e=this;return new Promise((function(t){setTimeout(t,e._getNextDelay())}))},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var e=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var t=this._options,n=t.maxRetries,r=void 0===n?f.maxRetries:n,i=t.connectionTimeout,o=void 0===i?f.connectionTimeout:i,a=t.WebSocket,s=void 0===a?c():a;if(this._retryCount>=r)this._debug("max retries reached",this._retryCount,">=",r);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),void 0===(u=s)||!u||2!==u.CLOSING)throw Error("No valid WebSocket class provided");var u;this._wait().then((function(){return e._getNextUrl(e._url)})).then((function(t){e._closeCalled||(e._debug("connect",{url:t,protocols:e._protocols}),e._ws=e._protocols?new s(t,e._protocols):new s(t),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout((function(){return e._handleTimeout()}),o))}))}}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new u(Error("TIMEOUT"),this))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new l(e,t,this))}catch(e){}}},e.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},e.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},e.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},e}()},622:function(e){var t,n,r,i,o;t=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,n=/^(?=([^\/?#]*))\1([^]*)$/,r=/(?:\/|^)\.(?=\/)/g,i=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(e,t,r){if(r=r||{},e=e.trim(),!(t=t.trim())){if(!r.alwaysNormalize)return e;var i=o.parseURL(e);if(!i)throw new Error("Error trying to parse base URL.");return i.path=o.normalizePath(i.path),o.buildURLFromParts(i)}var a=o.parseURL(t);if(!a)throw new Error("Error trying to parse relative URL.");if(a.scheme)return r.alwaysNormalize?(a.path=o.normalizePath(a.path),o.buildURLFromParts(a)):t;var s=o.parseURL(e);if(!s)throw new Error("Error trying to parse base URL.");if(!s.netLoc&&s.path&&"/"!==s.path[0]){var u=n.exec(s.path);s.netLoc=u[1],s.path=u[2]}s.netLoc&&!s.path&&(s.path="/");var l={scheme:s.scheme,netLoc:a.netLoc,path:null,params:a.params,query:a.query,fragment:a.fragment};if(!a.netLoc&&(l.netLoc=s.netLoc,"/"!==a.path[0]))if(a.path){var c=s.path,f=c.substring(0,c.lastIndexOf("/")+1)+a.path;l.path=o.normalizePath(f)}else l.path=s.path,a.params||(l.params=s.params,a.query||(l.query=s.query));return null===l.path&&(l.path=r.alwaysNormalize?o.normalizePath(a.path):a.path),o.buildURLFromParts(l)},parseURL:function(e){var n=t.exec(e);return n?{scheme:n[1]||"",netLoc:n[2]||"",path:n[3]||"",params:n[4]||"",query:n[5]||"",fragment:n[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(r,"");e.length!==(e=e.replace(i,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}},e.exports=o}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e].call(n.exports,n,n.exports,__webpack_require__),n.exports}__webpack_require__.d=(e,t)=>{for(var n in t)__webpack_require__.o(t,n)&&!__webpack_require__.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},__webpack_require__.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __webpack_exports__=__webpack_require__(666);return __webpack_exports__})()));